---
import { absoluteUrl } from "../../lib/strapi.js";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProductCard from "../../components/ProductCard.astro";
import { STRAPI_URL } from "../../lib/urls.js";

const url = new URL(Astro.request.url);
const q = url.searchParams.get("q")?.trim() ?? "";
const cat = url.searchParams.get("cat")?.trim() ?? "";
const sort = url.searchParams.get("sort")?.trim() ?? "createdAt:desc";
const page = Number(url.searchParams.get("page") ?? "1") || 1;
const pageSize = 24;

// normalizador
const normalize = (s = "") =>
  String(s)
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();

// regex opcional (búsqueda robusta)
let re = null;
if (q) {
  try {
    re = new RegExp(normalize(q), "i");
  } catch {
    re = null;
  }
}

const abs = (u) => {
  if (!u) return null;
  if (/^https?:\/\//i.test(u)) return u;
  return `${String(STRAPI_URL).replace(/\/$/, "")}${u.startsWith("/") ? "" : "/"}${u}`;
};

let products = [];
let categories = [];
let pageCount = 1;
let total = 0;

try {
  const qs = new URLSearchParams();
  qs.set("pagination[page]", String(page));
  qs.set("pagination[pageSize]", String(pageSize));
  qs.set("sort", sort);
  qs.set("populate", "*");

  if (cat) qs.set("filters[category][slug][$eq]", cat);

  const [productsRes, categoriesRes] = await Promise.all([
    fetch(`${STRAPI_URL}/api/products?${qs.toString()}`),
    fetch(`${STRAPI_URL}/api/categories?pagination[pageSize]=100&sort=name:asc`),
  ]);

  const productsData = await productsRes.json();
  const categoriesData = await categoriesRes.json();

  products = productsData?.data ?? [];
  pageCount = productsData?.meta?.pagination?.pageCount ?? 1;
  total = productsData?.meta?.pagination?.total ?? 0;

  // normaliza categorías a {name, slug}
  categories = (categoriesData?.data ?? []).map((c) => c?.attributes ?? c);
} catch {
  products = [];
  categories = [];
  pageCount = 1;
  total = 0;
}

// filtra por RegExp (sobre lo ya paginado)
const productsRegexFiltered = re
  ? products.filter((item) => {
      const p = item?.attributes ?? item;
      const haystack = normalize(
        `${p.name ?? ""} ${p.shortDescription ?? p.short_description ?? ""} ${JSON.stringify(p.description ?? "")}`
      );
      return re.test(haystack);
    })
  : products;

const hasFilters = !!(q || cat || (sort && sort !== "createdAt:desc"));
const shownCount = productsRegexFiltered.length;

const activeCategoryName =
  cat ? (categories.find((c) => c.slug === cat)?.name ?? null) : null;

// canonical para SEO
const canonical = "/productos/";
---

<BaseLayout
  title="Productos — ZetaGadget"
  description="Explora nuestro catálogo completo de gadgets y productos tecnológicos."
  canonical={canonical}
>
  <main class="container-page py-10">
    <!-- Header -->
    <div
      class="mb-8 rounded-3xl p-6 sm:p-8"
      style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"
    >
      <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">
        Catálogo
      </p>

      <div class="mt-2 flex flex-wrap items-end justify-between gap-3">
        <h1 class="text-3xl sm:text-4xl font-extrabold" style="color:#e5e5e5;">
          Productos
        </h1>

        <span
          class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"
          style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.22);"
        >
          {hasFilters
            ? `${shownCount} resultado${shownCount !== 1 ? "s" : ""}`
            : `${total} producto${total !== 1 ? "s" : ""}`}
        </span>
      </div>

      <p class="mt-2 text-sm sm:text-base" style="color: rgba(229,229,229,0.55);">
        Descubre nuestra selección de gadgets y tecnología premium.
      </p>

      {pageCount > 1 && (
        <p class="mt-2 text-xs" style="color: rgba(229,229,229,0.35);">
          Página {page} de {pageCount}
        </p>
      )}
    </div>

    <!-- Filtros (cliente) -->
    <div class="mb-6 flex gap-3 flex-col sm:flex-row">
      <input
        data-filter-q
        value={q}
        placeholder="Buscar producto..."
        class="px-4 py-2 rounded-xl bg-white/5 border border-white/10"
      />

      <select
        data-filter-cat
        class="px-4 py-2 rounded-xl bg-white/5 border border-white/10"
      >
        <option value="">Todas las categorías</option>
        {categories.map((c) => (
          <option value={c.slug} selected={cat === c.slug}>
            {c.name}
          </option>
        ))}
      </select>

      <select
        data-filter-sort
        class="px-4 py-2 rounded-xl bg-white/5 border border-white/10"
      >
        <option value="createdAt:desc" selected={sort === "createdAt:desc"}>Más recientes</option>
        <option value="price:asc" selected={sort === "price:asc"}>Precio ↑</option>
        <option value="price:desc" selected={sort === "price:desc"}>Precio ↓</option>
      </select>
    </div>

    <!-- Chips resumen -->
    {(q || activeCategoryName) && (
      <div
        class="mb-8 flex flex-wrap items-center justify-between gap-3 rounded-2xl px-4 py-3"
        style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"
      >
        <div class="flex flex-wrap items-center gap-2">
          {q && (
            <span
              class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium"
              style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.22);"
            >
              "{q}"
            </span>
          )}

          {activeCategoryName && (
            <span
              class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium"
              style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.22);"
            >
              {activeCategoryName}
            </span>
          )}
        </div>

        <a
          href="/productos/"
          class="inline-flex items-center gap-1.5 text-xs font-semibold transition-colors duration-200"
          style="color: rgba(229,229,229,0.55);"
        >
          Limpiar filtros
        </a>
      </div>
    )}

    <!-- Grid productos -->
    {productsRegexFiltered.length > 0 ? (
      <div
        data-products-root
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
      >
        {productsRegexFiltered.map((item) => {
          const p = item?.attributes ?? item;

          const firstImg =
  p.images?.[0]?.formats?.small?.url ??
  p.images?.[0]?.formats?.thumbnail?.url ??
  p.images?.[0]?.url ??
  null;

const imageUrl = firstImg ? absoluteUrl(firstImg) : null;

          // category es objeto plano (según curl)
          const catObj = p.category ?? null;

          return (
            <ProductCard
              product={{
                id: item.id ?? p.slug,
                name: p.name,
                slug: p.slug,
                price: p.price,
                shortDescription: p.shortDescription ?? p.short_description,
                imageUrl,
                featured: p.featured ?? false,
                stock: p.stock ?? 0,
                category: catObj ? { name: catObj.name, slug: catObj.slug } : undefined,
              }}
            />
          );
        })}
      </div>
    ) : (
      <div
        class="relative flex flex-col items-center text-center py-20 px-6 rounded-3xl overflow-hidden"
        style="background: #151a22; border: 1px solid rgba(255,255,255,0.07);"
      >
        <h2 class="text-xl font-semibold mb-2" style="color: #e5e5e5;">
          {hasFilters ? "Sin resultados para tu búsqueda" : "No hay productos disponibles"}
        </h2>
        <p class="text-sm max-w-sm mb-7" style="color: rgba(229,229,229,0.45);">
          {hasFilters
            ? "Prueba con otros términos, cambia la categoría o elimina los filtros activos."
            : "Vuelve pronto, estamos añadiendo nuevos productos constantemente."}
        </p>

        {hasFilters && (
          <a
            href="/productos/"
            class="px-5 py-2.5 rounded-xl text-sm font-semibold"
            style="background: #1e88e5; color: #fff;"
          >
            Limpiar filtros
          </a>
        )}
      </div>
    )}

    <!-- Paginación simple (sin componente) -->
    {pageCount > 1 && (
      <nav class="mt-12 flex justify-center gap-3 text-sm">
        {page > 1 && (
          <a
            href={`/productos/?page=${page - 1}${q ? `&q=${encodeURIComponent(q)}` : ""}${cat ? `&cat=${encodeURIComponent(cat)}` : ""}${sort ? `&sort=${encodeURIComponent(sort)}` : ""}`}
            class="px-4 py-2 rounded-xl border border-white/10 bg-white/5"
          >
            ← Anterior
          </a>
        )}

        {page < pageCount && (
          <a
            href={`/productos/?page=${page + 1}${q ? `&q=${encodeURIComponent(q)}` : ""}${cat ? `&cat=${encodeURIComponent(cat)}` : ""}${sort ? `&sort=${encodeURIComponent(sort)}` : ""}`}
            class="px-4 py-2 rounded-xl border border-white/10 bg-white/5"
          >
            Siguiente →
          </a>
        )}
      </nav>
    )}
  </main>

  <!-- Script que actualiza querystring y recarga -->
  <script type="module" src="/scripts/products-filter.js"></script>
</BaseLayout>