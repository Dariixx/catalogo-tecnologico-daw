---
// src/pages/productos/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProductCard from "../../components/ProductCard.astro";
import Pagination from "../../components/Pagination.astro";
import ProductsToolbar from "../../components/ProductsToolbar.jsx";

const { url } = Astro;
const params = new URL(url).searchParams;

const q = params.get("q") ?? "";
const cat = params.get("cat") ?? "";
const sort = params.get("sort") ?? "createdAt:desc";
const page = Math.max(1, parseInt(params.get("page") ?? "1", 10));
const pageSize = 12;

let products = [];
let categories = [];
let pageCount = 1;
let total = 0;

try {
  const [sortField, sortDir] = sort.split(":");
  const qs = new URLSearchParams({
    "pagination[page]": String(page),
    "pagination[pageSize]": String(pageSize),
    populate: "*",
    sort: `${sortField}:${sortDir ?? "asc"}`,
  });
  if (q) qs.set("filters[name][$containsi]", q);
  if (cat) qs.set("filters[category][slug][$eq]", cat);

  const [productsRes, categoriesRes] = await Promise.all([
    fetch(`${import.meta.env.STRAPI_URL}/api/products?${qs}`),
    fetch(`${import.meta.env.STRAPI_URL}/api/categories?pagination[limit]=100`),
  ]);

  const productsData = await productsRes.json();
  const categoriesData = await categoriesRes.json();

  products = productsData?.data ?? [];
  pageCount = productsData?.meta?.pagination?.pageCount ?? 1;
  total = productsData?.meta?.pagination?.total ?? 0;
  categories = categoriesData?.data ?? [];
} catch (e) {
  // silencioso
}

const hasFilters = !!(q || cat);
const categoryList = categories.map((c: any) => {
  const a = c.attributes ?? c;
  return { name: a.name, slug: a.slug };
});

const activeCategoryName = cat
  ? categoryList.find((c: any) => c.slug === cat)?.name ?? cat
  : null;
---

<BaseLayout
  title="Productos — ZetaGadget"
  description="Explora nuestro catálogo completo de gadgets y productos tecnológicos."
>
  <!-- Header página -->
  <div class="pb-8 pt-2">
    <div class="flex flex-col gap-2">
      <p class="text-xs font-semibold uppercase tracking-widest" style="color: #1e88e5;">
        Catálogo
      </p>
      <h1 class="text-3xl sm:text-4xl font-bold" style="color: #e5e5e5;">
        Productos
      </h1>
      <p class="text-sm" style="color: rgba(229,229,229,0.5);">
        Descubre nuestra selección de gadgets y tecnología premium.
      </p>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="mb-8">
    <ProductsToolbar client:load categories={categoryList} initial={{ q, category: cat, sort }} />
  </div>

  <!-- Filtros activos / resumen -->
  {(hasFilters || total > 0) && (
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <div class="flex flex-wrap items-center gap-2">
        {total > 0 && (
          <span class="text-sm" style="color: rgba(229,229,229,0.45);">
            {total} resultado{total !== 1 ? "s" : ""}
          </span>
        )}

        {q && (
          <span
            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium"
            style="background: rgba(30,136,229,0.1); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.2);"
          >
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" aria-hidden="true">
              <circle cx="4.5" cy="4.5" r="3.5" stroke="currentColor" stroke-width="1.2" />
              <path d="M7 7l1.5 1.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
            </svg>
            "{q}"
          </span>
        )}

        {activeCategoryName && (
          <span
            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium"
            style="background: rgba(30,136,229,0.1); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.2);"
          >
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" aria-hidden="true">
              <rect x="1" y="1" width="3.5" height="3.5" rx="0.8" fill="currentColor" opacity="0.7" />
              <rect x="5.5" y="1" width="3.5" height="3.5" rx="0.8" fill="currentColor" opacity="0.4" />
              <rect x="1" y="5.5" width="3.5" height="3.5" rx="0.8" fill="currentColor" opacity="0.4" />
              <rect x="5.5" y="5.5" width="3.5" height="3.5" rx="0.8" fill="currentColor" opacity="0.7" />
            </svg>
            {activeCategoryName}
          </span>
        )}
      </div>

      {hasFilters && (
        <a
          href="/productos"
          class="inline-flex items-center gap-1.5 text-xs font-medium transition-colors duration-200"
          style="color: rgba(229,229,229,0.4);"
          onmouseover="this.style.color='#e5e5e5';"
          onmouseout="this.style.color='rgba(229,229,229,0.4)';"
        >
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
            <path
              d="M2 2l8 8M10 2l-8 8"
              stroke="currentColor"
              stroke-width="1.4"
              stroke-linecap="round"
            />
          </svg>
          Limpiar filtros
        </a>
      )}
    </div>
  )}

  <!-- Grid productos -->
  {products.length > 0 ? (
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
      {products.map((item: any) => {
        const p = item.attributes ?? item;
        const catObj = p.category?.data?.attributes ?? p.category ?? null;
        return (
          <ProductCard
            product={{
              name: p.name,
              slug: p.slug,
              price: p.price,
              shortDescription: p.shortDescription ?? p.short_description,
              imageUrl: p.image?.data?.attributes?.url ?? p.imageUrl ?? null,
              featured: p.featured ?? false,
              stock: p.stock ?? 0,
              category: catObj ? { name: catObj.name, slug: catObj.slug } : undefined,
            }}
          />
        );
      })}
    </div>
  ) : (
    <!-- Empty state -->
    <div
      class="relative flex flex-col items-center text-center py-20 px-6 rounded-2xl overflow-hidden"
      style="background: #151a22; border: 1px solid rgba(255,255,255,0.07);"
    >
      <!-- Glow sutil -->
      <div aria-hidden="true" class="pointer-events-none absolute inset-0 flex items-center justify-center">
        <div
          class="w-80 h-48 rounded-full"
          style="background: radial-gradient(ellipse, rgba(30,136,229,0.07) 0%, transparent 70%); filter: blur(32px);"
        ></div>
      </div>

      <!-- Icono -->
      <div
        class="w-16 h-16 rounded-2xl flex items-center justify-center mb-5 z-10"
        style="background: rgba(30,136,229,0.08); border: 1px solid rgba(30,136,229,0.15);"
      >
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="8" stroke="rgba(30,136,229,0.6)" stroke-width="1.6" />
          <path d="M18 18l5 5" stroke="rgba(30,136,229,0.6)" stroke-width="1.6" stroke-linecap="round" />
          <path d="M9 12h6M12 9v6" stroke="rgba(229,229,229,0.3)" stroke-width="1.4" stroke-linecap="round" />
        </svg>
      </div>

      <h2 class="text-xl font-semibold mb-2 z-10" style="color: #e5e5e5;">
        {hasFilters ? "Sin resultados para tu búsqueda" : "No hay productos disponibles"}
      </h2>
      <p class="text-sm max-w-sm mb-7 z-10" style="color: rgba(229,229,229,0.45);">
        {hasFilters
          ? "Prueba con otros términos, cambia la categoría o elimina los filtros activos."
          : "Vuelve pronto, estamos añadiendo nuevos productos constantemente."}
      </p>

      {hasFilters && (
        <div class="flex flex-wrap items-center justify-center gap-3 z-10">
          <a
            href="/productos"
            class="px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
            style="background: #1e88e5; color: #fff; box-shadow: 0 4px 16px rgba(30,136,229,0.2);"
            onmouseover="this.style.background='#3aa0ff';"
            onmouseout="this.style.background='#1e88e5';"
          >
            Limpiar filtros
          </a>

          <a
            href="/categorias"
            class="px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
            style="background: rgba(255,255,255,0.04); color: rgba(229,229,229,0.7); border: 1px solid rgba(255,255,255,0.09);"
            onmouseover="this.style.color='#e5e5e5'; this.style.borderColor='rgba(255,255,255,0.18)';"
            onmouseout="this.style.color='rgba(229,229,229,0.7)'; this.style.borderColor='rgba(255,255,255,0.09)';"
          >
            Ver categorías
          </a>
        </div>
      )}
    </div>
  )}

  <!-- Paginación -->
  {pageCount > 1 && (
    <div class="mt-12 flex justify-center">
      <Pagination pagination={{ page, pageCount }} />
    </div>
  )}
</BaseLayout>