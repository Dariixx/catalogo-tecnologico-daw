---
// src/pages/blog/[slug].astro
import { getReadingTimeMinutes } from "../../lib/readingTime";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticleCard from "../../components/ArticleCard.astro";


export async function getStaticPaths() {
  try {
    const res = await fetch(
      `${import.meta.env.STRAPI_URL}/api/articles?pagination[limit]=1000&fields=slug`
    );
    const data = await res.json();
    return (data?.data ?? []).map((a: any) => ({
      params: { slug: a.attributes?.slug ?? a.slug },
    }));
  } catch {
    return [];
  }
}

const { slug } = Astro.params;

let article: any = null;
let more: any[] = [];

try {
  const res = await fetch(
    `${import.meta.env.STRAPI_URL}/api/articles?filters[slug][$eq]=${slug}&populate=*`
  );
  const data = await res.json();
  const raw = data?.data?.[0];
  if (raw) article = raw.attributes ?? raw;

  if (article) {
    const moreRes = await fetch(
      `${import.meta.env.STRAPI_URL}/api/articles?filters[slug][$ne]=${slug}&populate=*&pagination[limit]=3&sort=publishedAt:desc`
    );
    const moreData = await moreRes.json();
    more = moreData?.data ?? [];
  }
} catch (e) {
  // silencioso
}

if (!article) return Astro.redirect("/blog");

const a = article;
const readingMinutes = getReadingTimeMinutes({
  content: a.content,     // por si algún día existe
  blocks: a.blocks,       // tu caso real según Strapi
});
const author = a.author?.data?.attributes ?? a.author ?? null;
const coverUrl = a.cover?.data?.attributes?.url ?? a.coverUrl ?? null;
const publishedAt = a.publishedAt
  ? new Intl.DateTimeFormat("es-ES", { day: "numeric", month: "long", year: "numeric" }).format(
      new Date(a.publishedAt)
    )
  : null;

const tags: string[] =
  a.tags?.data?.map((t: any) => t.attributes?.name ?? t.name) ?? a.tags ?? [];
---

<BaseLayout
  title={`${a.title} — Blog ZetaGadget`}
  description={a.description ?? a.excerpt ?? a.title}
  image={coverUrl ?? undefined}
>
  <!-- Breadcrumbs -->
  <nav aria-label="Breadcrumb" class="mb-8">
    <ol class="flex flex-wrap items-center gap-1.5 text-sm">
      {[
        { label: "Inicio", href: "/" },
        { label: "Blog", href: "/blog" },
        { label: a.title, href: null },
      ].map((crumb, i) => (
        <li class="flex items-center gap-1.5">
          {i > 0 && (
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
              <path
                d="M4 2l4 4-4 4"
                stroke="rgba(229,229,229,0.25)"
                stroke-width="1.4"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          )}
          {crumb.href ? (
            <a
              href={crumb.href}
              class="transition-colors duration-200"
              style="color: rgba(229,229,229,0.45);"
              onmouseover="this.style.color='#3aa0ff';"
              onmouseout="this.style.color='rgba(229,229,229,0.45)';"
            >
              {crumb.label}
            </a>
          ) : (
            <span
              class="font-medium truncate max-w-[200px] sm:max-w-xs"
              style="color: rgba(229,229,229,0.8);"
              aria-current="page"
            >
              {crumb.label}
            </span>
          )}
        </li>
      ))}
    </ol>
  </nav>

  <!-- Layout: contenido centrado con sidebar opcional -->
  <div class="max-w-3xl mx-auto">
    <!-- Cover -->
    {coverUrl && (
      <div class="w-full overflow-hidden rounded-2xl mb-10" style="border: 1px solid rgba(255,255,255,0.08);">
        <img
          src={coverUrl}
          alt={a.title}
          class="w-full object-cover"
          style="max-height: 460px;"
          loading="eager"
          decoding="async"
        />
      </div>
    )}

    <!-- Tags -->
    {tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-5">
        {tags.map((tag: string) => (
          <span
            class="px-2.5 py-1 rounded-full text-xs font-medium"
            style="background: rgba(30,136,229,0.1); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.2);"
          >
            {tag}
          </span>
        ))}
      </div>
    )}

    <!-- Título -->
    <h1 class="text-3xl sm:text-4xl font-bold leading-tight mb-6" style="color: #e5e5e5;">
      {a.title}
    </h1>

    <!-- Meta bar -->
    <div class="flex flex-wrap items-center gap-x-5 gap-y-3 pb-8 mb-8" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
      {author && (
        <div class="flex items-center gap-2.5">
          {author.avatar?.data?.attributes?.url ? (
            <img
              src={author.avatar.data.attributes.url}
              alt={author.name}
              class="w-8 h-8 rounded-full object-cover"
              style="border: 1px solid rgba(255,255,255,0.1);"
            />
          ) : (
            <div
              class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shrink-0"
              style="background: rgba(30,136,229,0.15); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.2);"
            >
              {author.name?.charAt(0).toUpperCase()}
            </div>
          )}
          <span class="text-sm font-medium" style="color: rgba(229,229,229,0.75);">
            {author.name}
          </span>
        </div>
      )}

      <div class="flex flex-wrap items-center gap-x-5 gap-y-2">
        {publishedAt && (
          <span class="flex items-center gap-1.5 text-sm" style="color: rgba(229,229,229,0.4);">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
              <rect x="1.5" y="2.5" width="11" height="10" rx="2" stroke="currentColor" stroke-width="1.2" />
              <path d="M5 1.5v2M9 1.5v2M1.5 6h11" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
            </svg>
            {publishedAt}
          </span>
        )}

        {readingMinutes && (
        <span class="flex items-center gap-1.5 text-sm" style="color: rgba(229,229,229,0.4);">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.2" />
          <path d="M7 4.5V7l2 2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          {readingMinutes} min lectura
            </span>
          )}
      </div>
    </div>

    <!-- Descripción / Intro -->
    {(a.description ?? a.excerpt) && (
      <div
        class="rounded-xl px-6 py-5 mb-8"
        style="background: rgba(30,136,229,0.05); border-left: 3px solid #1e88e5; border-top: 1px solid rgba(30,136,229,0.12); border-bottom: 1px solid rgba(30,136,229,0.12); border-right: 1px solid rgba(30,136,229,0.12);"
      >
        <p class="text-base leading-relaxed italic" style="color: rgba(229,229,229,0.7);">
          {a.description ?? a.excerpt}
        </p>
      </div>
    )}

    <!-- Contenido principal -->
    {a.content && (
      <div
        class="rounded-2xl px-7 py-8 mb-10 text-sm leading-relaxed"
        style="background: #151a22; border: 1px solid rgba(255,255,255,0.08); color: rgba(229,229,229,0.75);"
      >
        <div class="article-content" set:html={a.content} />
      </div>
    )}

    <!-- Footer artículo: tags + compartir -->
    <div class="flex flex-wrap items-center justify-between gap-4 py-6 mb-16" style="border-top: 1px solid rgba(255,255,255,0.07);">
      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {tags.map((tag: string) => (
            <span
              class="px-2.5 py-1 rounded-full text-xs"
              style="background: rgba(255,255,255,0.04); color: rgba(229,229,229,0.45); border: 1px solid rgba(255,255,255,0.07);"
            >
              #{tag}
            </span>
          ))}
        </div>
      )}

      <a
        href="/blog"
        class="inline-flex items-center gap-1.5 text-sm font-medium transition-colors duration-200"
        style="color: rgba(229,229,229,0.45);"
        onmouseover="this.style.color='#3aa0ff';"
        onmouseout="this.style.color='rgba(229,229,229,0.45)';"
      >
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <path d="M11 7H3M6.5 4L3 7l3.5 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        Volver al blog
      </a>
    </div>
  </div>

  <!-- Más artículos -->
  {more.length > 0 && (
    <section>
      <div class="flex items-end justify-between mb-7 pb-5" style="border-bottom: 1px solid rgba(255,255,255,0.06);">
        <div>
          <p class="text-xs font-semibold uppercase tracking-widest mb-1.5" style="color: #1e88e5;">
            Seguir leyendo
          </p>
          <h2 class="text-xl font-bold" style="color: #e5e5e5;">
            Más artículos
          </h2>
        </div>

        <a
          href="/blog"
          class="hidden sm:inline-flex items-center gap-1.5 text-sm font-medium transition-colors duration-200"
          style="color: rgba(229,229,229,0.45);"
          onmouseover="this.style.color='#3aa0ff';"
          onmouseout="this.style.color='rgba(229,229,229,0.45)';"
        >
          Ver todos
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
            <path d="M3 7h8M7.5 4l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        {more.map((item: any) => {
          const m = item.attributes ?? item;
          const mauthor = m.author?.data?.attributes ?? m.author ?? null;
          return (
            <ArticleCard
              article={{
                title: m.title,
                slug: m.slug,
                description: m.description ?? m.excerpt,
                coverUrl: m.cover?.data?.attributes?.url ?? m.coverUrl ?? null,
                authorName: mauthor?.name ?? m.authorName ?? null,
                publishedAt: m.publishedAt,
                readingTime: m.readingTime ?? m.reading_time ?? null,
              }}
            />
          );
        })}
      </div>
    </section>
  )}
</BaseLayout>

<style is:global>
  .article-content h1,
  .article-content h2,
  .article-content h3,
  .article-content h4 {
    color: #e5e5e5;
    font-weight: 700;
    margin-top: 1.75rem;
    margin-bottom: 0.75rem;
    line-height: 1.3;
  }
  .article-content h2 { font-size: 1.35rem; }
  .article-content h3 { font-size: 1.15rem; }
  .article-content p  { margin-bottom: 1rem; }
  .article-content a  { color: #3aa0ff; text-decoration: underline; text-underline-offset: 3px; }
  .article-content a:hover { color: #1e88e5; }
  .article-content ul,
  .article-content ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
  }
  .article-content ul { list-style-type: disc; }
  .article-content ol { list-style-type: decimal; }
  .article-content li { margin-bottom: 0.35rem; }
  .article-content blockquote {
    border-left: 3px solid #1e88e5;
    padding: 0.75rem 1.25rem;
    margin: 1.5rem 0;
    background: rgba(30,136,229,0.05);
    border-radius: 0 8px 8px 0;
    color: rgba(229,229,229,0.65);
    font-style: italic;
  }
  .article-content pre {
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 1.25rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.82rem;
    line-height: 1.6;
  }
  .article-content code {
    background: rgba(30,136,229,0.12);
    color: #3aa0ff;
    padding: 0.15rem 0.45rem;
    border-radius: 4px;
    font-size: 0.83em;
    font-family: ui-monospace, monospace;
  }
  .article-content pre code {
    background: transparent;
    color: rgba(229,229,229,0.85);
    padding: 0;
  }
  .article-content img {
    border-radius: 10px;
    margin: 1.5rem 0;
    max-width: 100%;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .article-content hr {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.08);
    margin: 2rem 0;
  }
  .article-content strong { color: #e5e5e5; font-weight: 600; }
  .article-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.85rem;
  }
  .article-content th,
  .article-content td {
    padding: 0.65rem 1rem;
    border: 1px solid rgba(255,255,255,0.08);
    text-align: left;
  }
  .article-content th {
    background: rgba(30,136,229,0.08);
    color: #e5e5e5;
    font-weight: 600;
  }
</style>