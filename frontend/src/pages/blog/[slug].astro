---
// src/pages/blog/[slug].astro

import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticleCard from "../../components/ArticleCard.astro";
import { getReadingTimeMinutes } from "../../lib/readingTime";
import { strapiFetch } from "../../lib/strapi.js";

// ----------------------------------------------------
// Helpers: soporta Strapi "attributes" o respuesta plana
// ----------------------------------------------------
function unwrapEntity(entity) {
  if (!entity) return null;
  return entity.attributes ? { id: entity.id, ...entity.attributes } : entity;
}

function unwrapCollection(json) {
  const data = json?.data;
  if (Array.isArray(data)) return data.map(unwrapEntity).filter(Boolean);
  if (data) return [unwrapEntity(data)].filter(Boolean);
  return [];
}

// Base URL para construir absolutos (fallback seguro)
const STRAPI_URL =
  import.meta.env.STRAPI_URL ||
  process.env.STRAPI_URL ||
  "https://api.zetagadget.es";

const toAbs = (maybeUrl) => {
  if (!maybeUrl) return null;
  if (/^https?:\/\//i.test(maybeUrl)) return maybeUrl;
  try {
    return new URL(maybeUrl, STRAPI_URL).toString();
  } catch {
    return null;
  }
};

const pickMediaUrl = (media) => {
  const m =
    media?.data?.attributes ??
    media?.data ??
    media?.attributes ??
    media ??
    null;

  const rel =
    m?.url ??
    m?.formats?.large?.url ??
    m?.formats?.medium?.url ??
    m?.formats?.small?.url ??
    m?.formats?.thumbnail?.url ??
    null;

  return toAbs(rel);
};

// ----------------------------------------------------
// Static paths (tu API: item.slug plano)
// ----------------------------------------------------
export async function getStaticPaths() {
  const base = import.meta.env.STRAPI_URL;
  if (!base) throw new Error("Falta STRAPI_URL en el entorno de build");

  const url = `${base}/api/articles?fields[0]=slug&pagination[pageSize]=1000`;
  const res = await fetch(url);

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`Strapi no respondió (${res.status}) al generar static paths. ${text.slice(0, 200)}`);
  }

  const json = await res.json();
  const items = json?.data ?? [];

  return items
    .filter((x) => x?.slug)
    .map((x) => ({ params: { slug: x.slug } }));
}

const { slug } = Astro.params;

// ----------------------------------------------------
// Fetch artículo actual
// ----------------------------------------------------
const articleRes = await strapiFetch(
  `/articles?filters[slug][$eq]=${encodeURIComponent(slug)}&populate[author][populate]=avatar&populate[cover]=true`
);
const articles = unwrapCollection(articleRes);
const a = articles[0];

if (!a) {
  // En build: si llega aquí, no existe el slug o no hay permisos
  throw new Error(`Artículo no encontrado para slug: ${slug}`);
}

// ----------------------------------------------------
// Fetch "más artículos" (3)
// ----------------------------------------------------
const moreRes = await strapiFetch(
  `/articles?filters[slug][$ne]=${encodeURIComponent(slug)}&populate[author][populate]=avatar&populate[cover]=true&pagination[pageSize]=3&sort=publishedAt:desc`
);

const moreRaw = unwrapCollection(moreRes);
const more = moreRaw.slice(0, 3);

// ----------------------------------------------------
// Derived data
// ----------------------------------------------------
const readingMinutes = getReadingTimeMinutes({
  content: a.content,
  blocks: a.blocks,
});

const author =
  a.author?.data?.attributes ??
  a.author?.data ??
  a.author ??
  null;

const coverUrl = pickMediaUrl(a.cover);
const authorAvatarUrl = pickMediaUrl(author?.avatar);

const publishedAtRaw = a.publishedAt ? new Date(a.publishedAt) : null;
const publishedAt =
  publishedAtRaw
    ? new Intl.DateTimeFormat("es-ES", { day: "numeric", month: "long", year: "numeric" }).format(publishedAtRaw)
    : null;

const tags =
  a.tags?.data?.map((t) => t.attributes?.name ?? t.name) ??
  a.tags ??
  [];

const description = a.description ?? a.excerpt ?? a.title;

// ---------- Renderer básico para blocks ----------
const esc = (s = "") =>
  String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");

function textFromNode(node) {
  if (!node) return "";
  if (typeof node === "string") return node;
  if (Array.isArray(node)) return node.map(textFromNode).join("");
  if (node.text) return node.text;
  if (node.children) return node.children.map(textFromNode).join("");
  return "";
}

function renderBlocks(blocks) {
  if (!Array.isArray(blocks) || !blocks.length) return "";

  const out = blocks.map((b) => {
    const type = b.type ?? b.__type ?? b.kind;

    if (type === "heading" || type === "heading-1" || type === "heading-2" || type === "heading-3" || type === "heading-4") {
      const level = b.level ?? (type === "heading-1" ? 1 : type === "heading-2" ? 2 : type === "heading-3" ? 3 : 4);
      const t = esc(textFromNode(b.children));
      const tag = Math.min(4, Math.max(2, Number(level) || 2));
      return `<h${tag}>${t}</h${tag}>`;
    }

    if (type === "paragraph") {
      const t = esc(textFromNode(b.children));
      if (!t.trim()) return "";
      return `<p>${t}</p>`;
    }

    if (type === "quote" || type === "blockquote") {
      const t = esc(textFromNode(b.children));
      return `<blockquote>${t}</blockquote>`;
    }

    if (type === "list" || type === "bulleted-list" || type === "numbered-list") {
      const ordered = b.format === "ordered" || type === "numbered-list";
      const items = (b.children ?? []).map((li) => {
        const t = esc(textFromNode(li.children ?? li));
        return `<li>${t}</li>`;
      }).join("");
      return ordered ? `<ol>${items}</ol>` : `<ul>${items}</ul>`;
    }

    if (type === "code" || type === "code-block") {
      const code = esc(b.code ?? textFromNode(b.children));
      return `<pre><code>${code}</code></pre>`;
    }

    if (type === "image") {
      const url = b.image?.url ?? b.url ?? null;
      const alt = esc(b.alt ?? "");
      if (!url) return "";
      const abs = toAbs(url);
      return abs ? `<img src="${esc(abs)}" alt="${alt}" loading="lazy" decoding="async" />` : "";
    }

    const t = esc(textFromNode(b.children ?? b));
    return t.trim() ? `<p>${t}</p>` : "";
  });

  return out.filter(Boolean).join("\n");
}

const blocksHtml = !a.content ? renderBlocks(a.blocks) : "";
---

<BaseLayout
  title={`${a.title} — Blog ZetaGadget`}
  description={description}
  image={coverUrl ?? undefined}
  canonical={`/blog/${slug}/`}
>
  <main class="container-page py-10">
    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" class="mb-8">
      <ol
        class="flex flex-wrap items-center gap-1.5 text-sm rounded-2xl px-4 py-3"
        style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"
      >
        <li>
          <a
            href="/"
            class="transition-colors duration-200"
            style="color: rgba(229,229,229,0.55);"
            onmouseover="this.style.color='#3aa0ff';"
            onmouseout="this.style.color='rgba(229,229,229,0.55)';"
          >
            Inicio
          </a>
        </li>

        <li class="flex items-center gap-1.5">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
            <path d="M4 2l4 4-4 4" stroke="rgba(229,229,229,0.25)" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <a
            href="/blog"
            class="transition-colors duration-200"
            style="color: rgba(229,229,229,0.55);"
            onmouseover="this.style.color='#3aa0ff';"
            onmouseout="this.style.color='rgba(229,229,229,0.55)';"
          >
            Blog
          </a>
        </li>

        <li class="flex items-center gap-1.5">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
            <path d="M4 2l4 4-4 4" stroke="rgba(229,229,229,0.25)" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span
            class="font-semibold truncate max-w-[220px] sm:max-w-md"
            style="color: rgba(229,229,229,0.85);"
            aria-current="page"
          >
            {a.title}
          </span>
        </li>
      </ol>
    </nav>

    <!-- Hero / Cover -->
    <header class="mb-10">
      {coverUrl && (
        <div
          class="overflow-hidden rounded-3xl mb-8"
          style="background:#151a22; border: 1px solid rgba(255,255,255,0.08);"
        >
          <img
            src={coverUrl}
            alt={a.title}
            class="w-full object-cover"
            style="max-height: 520px;"
            loading="eager"
            decoding="async"
          />
        </div>
      )}

      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-5">
          {tags.map((tag) => (
            <span
              class="px-2.5 py-1 rounded-full text-xs font-semibold"
              style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.20);"
            >
              {tag}
            </span>
          ))}
        </div>
      )}

      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold leading-tight" style="color:#e5e5e5;">
        {a.title}
      </h1>

      {(a.description ?? a.excerpt) && (
        <p class="mt-4 text-base sm:text-lg leading-relaxed max-w-3xl" style="color: rgba(229,229,229,0.65);">
          {a.description ?? a.excerpt}
        </p>
      )}
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-6 items-start">
      <article
        class="rounded-3xl px-6 sm:px-8 py-8"
        style="background:#151a22; border: 1px solid rgba(255,255,255,0.08);"
      >
        <div class="flex flex-wrap items-center gap-x-5 gap-y-2 pb-6 mb-6" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
          {(author?.name ?? a.authorName) && (
            <span class="flex items-center gap-2.5 text-sm" style="color: rgba(229,229,229,0.70);">
              {authorAvatarUrl ? (
                <img
                  src={authorAvatarUrl}
                  alt={author?.name ?? a.authorName}
                  class="w-8 h-8 rounded-full object-cover"
                  style="border: 1px solid rgba(255,255,255,0.10);"
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <span
                  class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-extrabold"
                  style="background: rgba(30,136,229,0.15); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.25);"
                >
                  {(author?.name ?? a.authorName).charAt(0).toUpperCase()}
                </span>
              )}
              {author?.name ?? a.authorName}
            </span>
          )}

          {publishedAt && (
            <span class="flex items-center gap-1.5 text-sm" style="color: rgba(229,229,229,0.45);">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
                <rect x="1.5" y="2.5" width="11" height="10" rx="2" stroke="currentColor" stroke-width="1.2"/>
                <path d="M5 1.5v2M9 1.5v2M1.5 6h11" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
              </svg>
              {publishedAt}
            </span>
          )}

          {!!readingMinutes && (
            <span class="flex items-center gap-1.5 text-sm" style="color: rgba(229,229,229,0.45);">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
                <circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.2" />
                <path d="M7 4.5V7l2 2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {readingMinutes} min lectura
            </span>
          )}
        </div>

        {a.content ? (
          <div class="article-content" set:html={a.content} />
        ) : (
          <div class="article-content" set:html={blocksHtml} />
        )}
      </article>

      <aside class="lg:sticky lg:top-24 space-y-4">
        <div
          class="rounded-3xl p-6"
          style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"
        >
          <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">
            Acciones
          </p>

          <div class="mt-4 grid gap-3">
            <button
              type="button"
              id="copyLinkBtn"
              class="w-full rounded-xl px-4 py-3 text-sm font-semibold transition-all duration-200"
              style="background: rgba(30,136,229,0.12); color:#3aa0ff; border:1px solid rgba(30,136,229,0.25);"
            >
              Copiar enlace
            </button>

            <a
              href="/blog"
              class="w-full inline-flex items-center justify-center rounded-xl px-4 py-3 text-sm font-semibold transition-all duration-200"
              style="background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.85); border:1px solid rgba(255,255,255,0.10);"
            >
              Volver al blog
            </a>
          </div>

          <p id="copyMsg" class="mt-3 text-xs hidden" style="color: rgba(229,229,229,0.55);"></p>
        </div>

        <div
          class="rounded-3xl p-6"
          style="background:#151a22; border: 1px solid rgba(255,255,255,0.08);"
        >
          <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">
            Resumen
          </p>

          <div class="mt-3 text-sm leading-relaxed" style="color: rgba(229,229,229,0.60);">
            {description}
          </div>
        </div>
      </aside>
    </div>

    {more.length > 0 && (
      <section class="mt-14">
        <div class="flex items-end justify-between mb-7 pb-5" style="border-bottom: 1px solid rgba(255,255,255,0.06);">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest mb-1.5" style="color: #1e88e5;">
              Seguir leyendo
            </p>
            <h2 class="text-xl font-bold" style="color: #e5e5e5;">
              Más artículos
            </h2>
          </div>

          <a
            href="/blog"
            class="hidden sm:inline-flex items-center gap-1.5 text-sm font-medium transition-colors duration-200"
            style="color: rgba(229,229,229,0.45);"
            onmouseover="this.style.color='#3aa0ff';"
            onmouseout="this.style.color='rgba(229,229,229,0.45)';"
          >
            Ver todos
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
              <path d="M3 7h8M7.5 4l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {more.map((m: any) => {
            const mauthor =
              m.author?.data?.attributes ??
              m.author?.data ??
              m.author ??
              null;

            const mCoverAbs = pickMediaUrl(m.cover);

            return (
              <ArticleCard
                article={{
                  title: m.title,
                  slug: m.slug,
                  description: m.description ?? m.excerpt,
                  coverUrl: mCoverAbs,
                  authorName: mauthor?.name ?? m.authorName ?? null,
                  publishedAt: m.publishedAt,
                  readingTime: getReadingTimeMinutes({ content: m.content, blocks: m.blocks }),
                }}
              />
            );
          })}
        </div>
      </section>
    )}
  </main>

  <script type="module">
    const btn = document.getElementById("copyLinkBtn");
    const msg = document.getElementById("copyMsg");

    btn?.addEventListener("click", async () => {
      const url = window.location.href;
      try {
        await navigator.clipboard.writeText(url);
        msg.classList.remove("hidden");
        msg.textContent = "Enlace copiado ✅";
      } catch {
        msg.classList.remove("hidden");
        msg.textContent = "No se pudo copiar. Copia manual: " + url;
      }
    });
  </script>
</BaseLayout>

<style is:global>
  .article-content h2,
  .article-content h3,
  .article-content h4 {
    color: #e5e5e5;
    font-weight: 800;
    margin-top: 1.8rem;
    margin-bottom: 0.75rem;
    line-height: 1.25;
  }
  .article-content h2 { font-size: 1.35rem; }
  .article-content h3 { font-size: 1.15rem; }
  .article-content h4 { font-size: 1.02rem; }

  .article-content p {
    margin-bottom: 1rem;
    color: rgba(229,229,229,0.70);
    line-height: 1.85;
    font-size: 0.98rem;
  }

  .article-content a {
    color: #3aa0ff;
    text-decoration: underline;
    text-underline-offset: 3px;
  }
  .article-content a:hover { color: #1e88e5; }

  .article-content ul,
  .article-content ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
    color: rgba(229,229,229,0.70);
  }
  .article-content ul { list-style-type: disc; }
  .article-content ol { list-style-type: decimal; }
  .article-content li { margin-bottom: 0.35rem; }

  .article-content blockquote {
    border-left: 3px solid #1e88e5;
    padding: 0.9rem 1.25rem;
    margin: 1.5rem 0;
    background: rgba(30,136,229,0.05);
    border-radius: 0 12px 12px 0;
    color: rgba(229,229,229,0.65);
    font-style: italic;
  }

  .article-content pre {
    background: rgba(0,0,0,0.40);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px;
    padding: 1.25rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.85rem;
    line-height: 1.65;
  }
  .article-content code {
    background: rgba(30,136,229,0.12);
    color: #3aa0ff;
    padding: 0.15rem 0.45rem;
    border-radius: 6px;
    font-size: 0.9em;
    font-family: ui-monospace, monospace;
  }
  .article-content pre code {
    background: transparent;
    color: rgba(229,229,229,0.85);
    padding: 0;
  }

  .article-content img {
    border-radius: 14px;
    margin: 1.5rem 0;
    max-width: 100%;
    border: 1px solid rgba(255,255,255,0.08);
  }

  .article-content hr {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.08);
    margin: 2rem 0;
  }

  .article-content strong { color: #e5e5e5; font-weight: 700; }

  .article-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
  }
  .article-content th,
  .article-content td {
    padding: 0.7rem 1rem;
    border: 1px solid rgba(255,255,255,0.08);
    text-align: left;
  }
  .article-content th {
    background: rgba(30,136,229,0.08);
    color: #e5e5e5;
    font-weight: 700;
  }
</style>