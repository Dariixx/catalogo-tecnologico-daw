---
// src/pages/blog/index.astro
import { getReadingTimeMinutes } from "../../lib/readingTime";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArticleCard from "../../components/ArticleCard.astro";
import Pagination from "../../components/Pagination.astro";

const STRAPI_URL =
  import.meta.env.STRAPI_URL ||
  process.env.STRAPI_URL ||
  "https://api.zetagadget.es";

const params = new URL(Astro.url).searchParams;

const page = Math.max(1, parseInt(params.get("page") ?? "1", 10));
const pageSize = 9;

const q = (params.get("q") ?? "").trim();
const hasQuery = !!q;

let articles = [];
let pageCount = 1;
let total = 0;
let featured = null;

const toAbs = (maybeUrl) => {
  if (!maybeUrl) return null;
  if (/^https?:\/\//i.test(maybeUrl)) return maybeUrl;
  try {
    return new URL(maybeUrl, STRAPI_URL).toString();
  } catch {
    return null;
  }
};

const pickMediaUrl = (media) => {
  // Soporta:
  // - v4: media.data.attributes
  // - "plano": media.url, media.formats
  const m =
    media?.data?.attributes ??
    media?.data ??
    media?.attributes ??
    media ??
    null;

  const rel =
    m?.url ??
    m?.formats?.large?.url ??
    m?.formats?.medium?.url ??
    m?.formats?.small?.url ??
    m?.formats?.thumbnail?.url ??
    null;

  return toAbs(rel);
};

try {
  const populate =
    "populate[cover]=true&populate[author][populate]=avatar&populate[category]=true";

  const qs = new URLSearchParams({
    "pagination[page]": String(page),
    "pagination[pageSize]": String(pageSize),
    sort: "publishedAt:desc",
  });

  if (q) qs.set("filters[title][$containsi]", q);

  const [mainRes, featuredRes] = await Promise.all([
    fetch(`${STRAPI_URL}/api/articles?${populate}&${qs.toString()}`),
    page === 1
      ? fetch(
          `${STRAPI_URL}/api/articles?${populate}&pagination[limit]=1&sort=publishedAt:desc&filters[featured][$eq]=true`
        )
      : Promise.resolve(null),
  ]);

  const mainData = await mainRes.json();
  articles = mainData?.data ?? [];
  pageCount = mainData?.meta?.pagination?.pageCount ?? 1;
  total = mainData?.meta?.pagination?.total ?? 0;

  if (featuredRes) {
    const featuredData = await featuredRes.json();
    const raw = featuredData?.data?.[0];
    if (raw) featured = raw.attributes ?? raw;
  }
} catch {
  articles = [];
  pageCount = 1;
  total = 0;
  featured = null;
}

const formatDate = (iso) =>
  new Intl.DateTimeFormat("es-ES", { day: "numeric", month: "short", year: "numeric" }).format(
    new Date(iso)
  );

// Evita duplicar el destacado
const featuredSlug = featured?.slug ?? null;
const gridArticles =
  page === 1 && featuredSlug && !hasQuery
    ? articles.filter((it) => (it.attributes?.slug ?? it.slug) !== featuredSlug)
    : articles;

// URLs para paginación y limpiar
const baseUrl = "/blog";
const clearUrl = "/blog";

const buildUrl = (nextPage) => {
  const u = new URL(baseUrl, "https://dummy.local");
  if (q) u.searchParams.set("q", q);
  if (nextPage && nextPage > 1) u.searchParams.set("page", String(nextPage));
  return u.pathname + (u.search ? u.search : "");
};
---

<BaseLayout
  title="Blog — ZetaGadget"
  description="Artículos, guías y noticias sobre tecnología y gadgets en ZetaGadget."
>
  <main class="container-page py-10">
    <!-- Header (card) -->
    <div
      class="mb-8 rounded-3xl p-6 sm:p-8"
      style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"
    >
      <div class="flex flex-col gap-2 max-w-2xl">
        <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">
          Blog
        </p>

        <div class="flex flex-wrap items-end justify-between gap-3">
          <h1 class="text-3xl sm:text-4xl font-extrabold" style="color:#e5e5e5;">
            Artículos & Guías
          </h1>

          {total > 0 && (
            <span
              class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"
              style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.22);"
            >
              {total} artículo{total !== 1 ? "s" : ""}
            </span>
          )}
        </div>

        <p class="text-sm sm:text-base leading-relaxed" style="color: rgba(229,229,229,0.55);">
          Noticias, análisis y consejos sobre el mundo tech. Actualizado regularmente.
        </p>

        {pageCount > 1 && (
          <p class="text-xs mt-1" style="color: rgba(229,229,229,0.35);">
            Página {page} de {pageCount}
          </p>
        )}
      </div>
    </div>

    <!-- Toolbar: búsqueda -->
    <form
      class="mb-10 rounded-3xl p-4 sm:p-5 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between"
      style="background:#151a22; border: 1px solid rgba(255,255,255,0.08);"
      method="get"
      action="/blog"
    >
      <div class="flex-1 flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0"
          style="background: rgba(30,136,229,0.10); border: 1px solid rgba(30,136,229,0.20);"
        >
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true">
            <circle cx="8" cy="8" r="5" stroke="rgba(58,160,255,0.9)" stroke-width="1.5"/>
            <path d="M12 12l4 4" stroke="rgba(58,160,255,0.9)" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>

        <div class="w-full">
          <label class="block text-xs font-semibold mb-1" style="color: rgba(229,229,229,0.65);">
            Buscar artículos
          </label>
          <input
            name="q"
            value={q}
            placeholder="Ej: auriculares, iPhone, guías, recomendaciones…"
            class="w-full rounded-xl px-4 py-3 text-sm outline-none"
            style="background:#0f1115; border: 1px solid rgba(255,255,255,0.12); color:#e5e5e5;"
          />
        </div>
      </div>

      <div class="flex items-center gap-2 sm:pl-3">
        <button
          type="submit"
          class="rounded-xl px-4 py-3 text-sm font-semibold transition-all duration-200"
          style="background:#1e88e5; color:#fff; border:1px solid #1e88e5;"
          onmouseover="this.style.background='#3aa0ff';"
          onmouseout="this.style.background='#1e88e5';"
        >
          Buscar
        </button>

        {hasQuery && (
          <a
            href={clearUrl}
            class="rounded-xl px-4 py-3 text-sm font-semibold transition-all duration-200"
            style="background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.85); border:1px solid rgba(255,255,255,0.10);"
            onmouseover="this.style.borderColor='rgba(58,160,255,0.35)';"
            onmouseout="this.style.borderColor='rgba(255,255,255,0.10)';"
          >
            Limpiar
          </a>
        )}
      </div>
    </form>

    <!-- Chips filtros activos -->
    {(hasQuery || total > 0) && (
      <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap items-center gap-2">
          {total > 0 && (
            <span class="text-sm" style="color: rgba(229,229,229,0.45);">
              {total} resultado{total !== 1 ? "s" : ""}
            </span>
          )}

          {hasQuery && (
            <span
              class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold"
              style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.20);"
            >
              <svg width="10" height="10" viewBox="0 0 10 10" fill="none" aria-hidden="true">
                <circle cx="4.5" cy="4.5" r="3.5" stroke="currentColor" stroke-width="1.2" />
                <path d="M7 7l1.5 1.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
              </svg>
              “{q}”
            </span>
          )}
        </div>

        {hasQuery && (
          <a
            href={clearUrl}
            class="inline-flex items-center gap-1.5 text-xs font-semibold transition-colors duration-200"
            style="color: rgba(229,229,229,0.45);"
            onmouseover="this.style.color='#e5e5e5';"
            onmouseout="this.style.color='rgba(229,229,229,0.45)';"
          >
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
              <path d="M2 2l8 8M10 2l-8 8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
            </svg>
            Quitar filtro
          </a>
        )}
      </div>
    )}

    <!-- Artículo destacado (solo página 1 y sin búsqueda) -->
    {page === 1 && featured && !hasQuery && (() => {
      const coverAbs = pickMediaUrl(featured.cover);
      const author =
        featured.author?.data?.attributes ??
        featured.author?.data ??
        featured.author ??
        null;

      const authorAvatarAbs = pickMediaUrl(author?.avatar);

      return (
        <a
          href={`/blog/${featured.slug}`}
          class="group block rounded-3xl overflow-hidden mb-12 transition-all duration-300"
          style="background: #151a22; border: 1px solid rgba(255,255,255,0.08);"
          onmouseover="this.style.border='1px solid rgba(58,160,255,0.28)'; this.style.boxShadow='0 14px 48px rgba(30,136,229,0.10)';"
          onmouseout="this.style.border='1px solid rgba(255,255,255,0.08)'; this.style.boxShadow='none';"
        >
          <div class="grid grid-cols-1 lg:grid-cols-2">
            <div class="relative overflow-hidden" style="min-height: 260px;">
              {coverAbs ? (
                <img
                  src={coverAbs}
                  alt={featured.title}
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  style="min-height: 260px;"
                  loading="eager"
                  decoding="async"
                />
              ) : (
                <div
                  class="w-full h-full flex items-center justify-center"
                  style="background: rgba(255,255,255,0.03); min-height: 260px;"
                >
                  <svg width="52" height="52" viewBox="0 0 52 52" fill="none" aria-hidden="true">
                    <rect width="52" height="52" rx="12" fill="rgba(30,136,229,0.07)"/>
                    <path d="M13 36L21 26l6 7 5-5 7 8H13z" fill="none" stroke="rgba(229,229,229,0.15)" stroke-width="1.5" stroke-linejoin="round"/>
                    <circle cx="21" cy="22" r="4" fill="none" stroke="rgba(229,229,229,0.15)" stroke-width="1.5"/>
                  </svg>
                </div>
              )}

              <div class="absolute top-4 left-4">
                <span
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold"
                  style="background: rgba(30,136,229,0.88); color: #fff; backdrop-filter: blur(8px);"
                >
                  <span class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                  Destacado
                </span>
              </div>
            </div>

            <div class="flex flex-col justify-center gap-4 p-7 sm:p-8 lg:p-10">
              <p class="text-xs font-semibold uppercase tracking-widest" style="color: #1e88e5;">
                Artículo destacado
              </p>

              <h2 class="text-xl sm:text-2xl font-extrabold leading-snug" style="color:#e5e5e5;">
                {featured.title}
              </h2>

              {featured.description && (
                <p class="text-sm leading-relaxed line-clamp-3" style="color: rgba(229,229,229,0.58);">
                  {featured.description}
                </p>
              )}

              <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                {(author?.name ?? featured.authorName) && (
                  <span class="flex items-center gap-2 text-xs" style="color: rgba(229,229,229,0.45);">
                    {authorAvatarAbs ? (
                      <img
                        src={authorAvatarAbs}
                        alt={author?.name ?? featured.authorName}
                        class="w-6 h-6 rounded-full object-cover"
                        style="border: 1px solid rgba(255,255,255,0.10);"
                        loading="lazy"
                        decoding="async"
                      />
                    ) : null}
                    {author?.name ?? featured.authorName}
                  </span>
                )}

                {featured.publishedAt && (
                  <span class="flex items-center gap-1.5 text-xs" style="color: rgba(229,229,229,0.4);">
                    <svg width="13" height="13" viewBox="0 0 13 13" fill="none" aria-hidden="true">
                      <rect x="1.5" y="2.5" width="10" height="9" rx="1.5" stroke="currentColor" stroke-width="1.2"/>
                      <path d="M4.5 1.5v2M8.5 1.5v2M1.5 5.5h10" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                    </svg>
                    {formatDate(featured.publishedAt)}
                  </span>
                )}

                {(() => {
                  const rt = getReadingTimeMinutes({ content: featured.content, blocks: featured.blocks });
                  return rt ? (
                    <span class="flex items-center gap-1.5 text-xs" style="color: rgba(229,229,229,0.4);">
                      <svg width="13" height="13" viewBox="0 0 13 13" fill="none" aria-hidden="true">
                        <circle cx="6.5" cy="6.5" r="5" stroke="currentColor" stroke-width="1.2"/>
                        <path d="M6.5 3.5v3l2 1.2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
                      </svg>
                      {rt} min lectura
                    </span>
                  ) : null;
                })()}
              </div>

              <span class="mt-2 inline-flex items-center gap-2 text-sm font-semibold w-fit" style="color:#3aa0ff;">
                Leer artículo
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true" class="transition-transform duration-200 group-hover:translate-x-0.5">
                  <path d="M3 7h8M7.5 4l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </div>
          </div>
        </a>
      );
    })()}

    <!-- GRID -->
    {gridArticles.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {gridArticles.map((item: any) => {
          const a = item?.attributes ?? item;

          const author =
            a.author?.data?.attributes ??
            a.author?.data ??
            a.author ??
            null;

          const coverAbs = pickMediaUrl(a.cover);

          return (
            <ArticleCard
              article={{
                title: a.title,
                slug: a.slug,
                description: a.description ?? a.excerpt,
                coverUrl: coverAbs,
                authorName: author?.name ?? a.authorName ?? null,
                publishedAt: a.publishedAt,
                readingTime: getReadingTimeMinutes({ content: a.content, blocks: a.blocks }),
              }}
            />
          );
        })}
      </div>
    ) : (
      <div
        class="relative flex flex-col items-center text-center py-24 px-6 rounded-3xl overflow-hidden"
        style="background: #151a22; border: 1px solid rgba(255,255,255,0.07);"
      >
        <div aria-hidden="true" class="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div
            class="w-80 h-48 rounded-full"
            style="background: radial-gradient(ellipse, rgba(30,136,229,0.07) 0%, transparent 70%); filter: blur(32px);"
          ></div>
        </div>

        <div
          class="w-16 h-16 rounded-2xl flex items-center justify-center mb-5 z-10"
          style="background: rgba(30,136,229,0.08); border: 1px solid rgba(30,136,229,0.15);"
        >
          <svg width="28" height="28" viewBox="0 0 28 28" fill="none" aria-hidden="true">
            <rect x="4" y="5" width="20" height="18" rx="3" fill="none" stroke="rgba(30,136,229,0.5)" stroke-width="1.5"/>
            <path d="M9 10h10M9 14h10M9 18h6" stroke="rgba(229,229,229,0.25)" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
        </div>

        <h2 class="text-xl font-semibold mb-2 z-10" style="color: #e5e5e5;">
          {hasQuery ? "No hay resultados para tu búsqueda" : "No hay artículos publicados"}
        </h2>
        <p class="text-sm max-w-sm mb-7 z-10" style="color: rgba(229,229,229,0.45);">
          {hasQuery
            ? "Prueba con otros términos o limpia el filtro."
            : "Estamos preparando contenido de calidad. Vuelve pronto para leer nuestros artículos y guías."}
        </p>

        <div class="flex flex-wrap gap-3 z-10">
          {hasQuery ? (
            <a
              href="/blog"
              class="px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
              style="background: #1e88e5; color: #fff; box-shadow: 0 4px 16px rgba(30,136,229,0.2);"
              onmouseover="this.style.background='#3aa0ff';"
              onmouseout="this.style.background='#1e88e5';"
            >
              Limpiar búsqueda
            </a>
          ) : null}

          <a
            href="/productos"
            class="px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
            style="background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.9); border:1px solid rgba(255,255,255,0.10);"
            onmouseover="this.style.borderColor='rgba(58,160,255,0.35)';"
            onmouseout="this.style.borderColor='rgba(255,255,255,0.10)';"
          >
            Explorar productos
          </a>
        </div>
      </div>
    )}

    {pageCount > 1 && (
      <div class="mt-12 flex justify-center">
        <Pagination
          pagination={{ page, pageCount }}
          buildUrl={buildUrl}
        />
      </div>
    )}
  </main>
</BaseLayout>