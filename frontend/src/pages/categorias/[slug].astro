---
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProductCard from "../../components/ProductCard.astro";
import Pagination from "../../components/Pagination.astro";

import { strapiFetch, unwrapCollection } from "../../lib/strapi.js";
import { mapProductCard } from "../../lib/mappers.js";

export async function getStaticPaths() {
  // Usa strapiFetch (no fetch manual) para no depender de STRAPI_URL aquí
  try {
    const json = await strapiFetch("/categories?pagination[pageSize]=1000&fields[0]=slug");
    const cats = unwrapCollection(json);

    return cats
      .map((c) => ({ params: { slug: c.slug } }))
      .filter((x) => !!x?.params?.slug);
  } catch (e) {
    return [];
  }
}

const { slug } = Astro.params;

// paginación por query (?page=2)
const params = new URL(Astro.url).searchParams;
const page = Math.max(1, parseInt(params.get("page") ?? "1", 10));
const pageSize = 12;

const catJson = await strapiFetch(
  `/categories?filters[slug][$eq]=${encodeURIComponent(slug)}&fields[0]=name&fields[1]=slug&fields[2]=description`
);
const category = unwrapCollection(catJson)[0] ?? null;

if (!category) return Astro.redirect("/categorias");

const prodJson = await strapiFetch(
  `/products` +
    `?filters[category][slug][$eq]=${encodeURIComponent(slug)}` +
    `&fields[0]=name&fields[1]=slug&fields[2]=price&fields[3]=shortDescription&fields[4]=stock` +
    `&populate[0]=images&populate[1]=category` +
    `&pagination[page]=${page}&pagination[pageSize]=${pageSize}` +
    `&sort=createdAt:desc`
);

const rawProducts = unwrapCollection(prodJson);
const products = rawProducts.map(mapProductCard);

const pageCount = prodJson?.meta?.pagination?.pageCount ?? 1;
const total = prodJson?.meta?.pagination?.total ?? products.length ?? 0;
---

<BaseLayout
  title={`${category.name} — ZetaGadget`}
  description={category.description ?? `Explora productos de ${category.name} en ZetaGadget.`}
>
  <main class="container-page py-10">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <ol
        class="flex flex-wrap items-center gap-2 text-sm px-4 py-3 rounded-2xl"
        style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);"
      >
        <li><a href="/" style="color: rgba(229,229,229,0.55);">Inicio</a></li>
        <li style="color: rgba(229,229,229,0.25);">›</li>
        <li><a href="/categorias" style="color: rgba(229,229,229,0.55);">Categorías</a></li>
        <li style="color: rgba(229,229,229,0.25);">›</li>
        <li class="font-semibold" style="color: rgba(229,229,229,0.9);">{category.name}</li>
      </ol>
    </nav>

    <!-- Header categoría -->
    <section
      class="relative rounded-3xl overflow-hidden p-6 sm:p-8 mb-10"
      style="background: #151a22; border: 1px solid rgba(255,255,255,0.08);"
    >
      <div aria-hidden="true" class="pointer-events-none absolute inset-0">
        <div
          class="absolute -top-10 -left-10 w-72 h-56 rounded-full"
          style="background: radial-gradient(ellipse, rgba(30,136,229,0.14) 0%, transparent 70%); filter: blur(34px);"
        ></div>
      </div>

      <div class="relative z-10">
        <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">
          Categoría
        </p>

        <div class="mt-2 flex flex-wrap items-end justify-between gap-3">
          <h1 class="text-2xl sm:text-3xl font-extrabold" style="color:#e5e5e5;">
            {category.name}
          </h1>

          {total > 0 && (
            <span
              class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold"
              style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.22);"
            >
              {total} producto{total !== 1 ? "s" : ""}
            </span>
          )}
        </div>

        {category.description && (
          <p class="mt-4 text-sm sm:text-base leading-relaxed max-w-3xl" style="color: rgba(229,229,229,0.55);">
            {category.description}
          </p>
        )}

        <div class="mt-6 flex flex-wrap gap-3">
          <a
            href="/productos"
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
            style="background: rgba(30,136,229,0.12); color:#3aa0ff; border:1px solid rgba(30,136,229,0.25);"
          >
            Ver todo el catálogo
          </a>

          <a
            href="/categorias"
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
            style="background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.85); border: 1px solid rgba(255,255,255,0.10);"
          >
            Otras categorías
          </a>
        </div>
      </div>
    </section>

    <!-- Productos -->
    <section>
      <div class="flex items-end justify-between gap-3 mb-6">
        <div>
          <h2 class="text-lg font-semibold" style="color:#e5e5e5;">Productos</h2>
          <p class="text-sm" style="color: rgba(229,229,229,0.55);">
            {total > 0 ? `${total} resultado${total !== 1 ? "s" : ""}` : "Aún sin resultados."}
          </p>
        </div>

        {pageCount > 1 && (
          <p class="text-xs" style="color: rgba(229,229,229,0.35);">
            Página {page} de {pageCount}
          </p>
        )}
      </div>

      {products.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {products.map((p) => <ProductCard product={p} />)}
        </div>
      ) : (
        <div
          class="relative flex flex-col items-center text-center py-20 px-6 rounded-3xl overflow-hidden"
          style="background: #151a22; border: 1px solid rgba(255,255,255,0.07);"
        >
          <div aria-hidden="true" class="pointer-events-none absolute inset-0 flex items-center justify-center">
            <div
              class="w-72 h-40 rounded-full"
              style="background: radial-gradient(ellipse, rgba(30,136,229,0.07) 0%, transparent 70%); filter: blur(28px);"
            ></div>
          </div>

          <h3 class="text-lg font-semibold mb-2 z-10" style="color: #e5e5e5;">
            Sin productos en esta categoría
          </h3>
          <p class="text-sm max-w-xs mb-7 z-10" style="color: rgba(229,229,229,0.45);">
            Aún no hay productos disponibles aquí. Explora otras categorías o vuelve pronto.
          </p>

          <div class="flex flex-wrap justify-center gap-3 z-10">
            <a
              href="/productos"
              class="px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
              style="background: #1e88e5; color: #fff; box-shadow: 0 4px 16px rgba(30,136,229,0.2);"
            >
              Ver todos los productos
            </a>
            <a
              href="/categorias"
              class="px-5 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200"
              style="background: rgba(255,255,255,0.04); color: rgba(229,229,229,0.7); border: 1px solid rgba(255,255,255,0.09);"
            >
              Otras categorías
            </a>
          </div>
        </div>
      )}

      {pageCount > 1 && (
        <div class="mt-12 flex justify-center">
          <Pagination pagination={{ page, pageCount }} />
        </div>
      )}
    </section>
  </main>
</BaseLayout>