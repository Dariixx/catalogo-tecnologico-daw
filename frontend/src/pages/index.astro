---
import BaseLayout from "../layouts/BaseLayout.astro";
import { STRAPI_URL } from "../lib/urls.js";

const pick = (arr, n = 3) => (Array.isArray(arr) ? arr.slice(0, n) : []);

const abs = (u) => {
  if (!u) return null;
  if (/^https?:\/\//i.test(u)) return u;
  return `${String(STRAPI_URL).replace(/\/$/, "")}${u.startsWith("/") ? "" : "/"}${u}`;
};

let cats = [];
let prods = [];
let arts = [];

try {
  const [cRes, pRes, aRes] = await Promise.all([
    fetch(`${STRAPI_URL}/api/categories?sort=name:asc&pagination[pageSize]=3`),
    fetch(`${STRAPI_URL}/api/products?sort=createdAt:desc&pagination[pageSize]=3&populate=*`),
    fetch(`${STRAPI_URL}/api/articles?sort=publishedAt:desc&pagination[pageSize]=3&populate=*`),
  ]);

  const c = await cRes.json();
  const p = await pRes.json();
  const a = await aRes.json();

  cats = pick(c?.data, 3).map((x) => x?.attributes ?? x);
  prods = pick(p?.data, 3).map((x) => x?.attributes ?? x);
  arts = pick(a?.data, 3).map((x) => x?.attributes ?? x);
} catch {
  cats = [];
  prods = [];
  arts = [];
}
---

<BaseLayout
  title="ZetaGadget — Tecnología con criterio"
  description="Selección de gadgets, comparativas y artículos para comprar con cabeza."
>
  <main class="container-page py-10 space-y-12">

    <!-- HERO simple -->
    <section class="rounded-3xl p-8" style="background:#151a22;border:1px solid rgba(255,255,255,0.08);">
      <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">ZetaGadget</p>
      <h1 class="mt-2 text-3xl sm:text-4xl font-extrabold" style="color:#e5e5e5;">
        Tecnología con criterio, sin humo.
      </h1>
      <p class="mt-3 max-w-2xl" style="color: rgba(229,229,229,0.55);">
        Catálogo curado + blog útil para elegir mejor. Productos reales, fichas claras y comparativas.
      </p>

      <div class="mt-6 flex flex-wrap gap-3">
        <a href="/productos/" class="px-5 py-3 rounded-xl text-sm font-semibold"
          style="background:#1e88e5;color:#fff;border:1px solid #1e88e5;">
          Ver catálogo
        </a>
        <a href="/blog/" class="px-5 py-3 rounded-xl text-sm font-semibold"
          style="background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.85); border:1px solid rgba(255,255,255,0.10);">
          Leer blog
        </a>
      </div>
    </section>

    <!-- CATEGORÍAS (3) -->
    <section>
      <div class="flex items-end justify-between mb-5">
        <div>
          <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">Explorar</p>
          <h2 class="text-xl font-bold" style="color:#e5e5e5;">Categorías destacadas</h2>
        </div>
        <a href="/categorias/" class="text-sm" style="color: rgba(229,229,229,0.55);">Ver todas</a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        {cats.map((c) => (
          <a href={`/categorias/${c.slug}/`} class="rounded-3xl p-6 block"
            style="background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);">
            <div class="text-sm font-semibold" style="color:#e5e5e5;">{c.name}</div>
            {c.description && <p class="mt-2 text-sm" style="color: rgba(229,229,229,0.55);">{c.description}</p>}
          </a>
        ))}
      </div>
    </section>

    <!-- PRODUCTOS (3) -->
    <section>
      <div class="flex items-end justify-between mb-5">
        <div>
          <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">Selección</p>
          <h2 class="text-xl font-bold" style="color:#e5e5e5;">Productos recientes</h2>
        </div>
        <a href="/productos/" class="text-sm" style="color: rgba(229,229,229,0.55);">Ver todos</a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        {prods.map((p) => {
          const img =
            p.images?.[0]?.formats?.small?.url ??
            p.images?.[0]?.formats?.thumbnail?.url ??
            p.images?.[0]?.url ??
            null;
          const imgAbs = img ? abs(img) : null;

          return (
            <a href={`/productos/${p.slug}/`} class="rounded-3xl overflow-hidden block"
              style="background:#151a22;border:1px solid rgba(255,255,255,0.08);">
              <div class="aspect-[4/3]" style="background: rgba(255,255,255,0.03);">
                {imgAbs ? (
                  <img src={imgAbs} alt={p.name} class="w-full h-full object-cover" loading="lazy" decoding="async" />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-sm" style="color: rgba(229,229,229,0.45);">Sin imagen</div>
                )}
              </div>
              <div class="p-5">
                <div class="font-semibold" style="color:#e5e5e5;">{p.name}</div>
                {p.shortDescription && <p class="mt-2 text-sm" style="color: rgba(229,229,229,0.55);">{p.shortDescription}</p>}
                {typeof p.price === "number" && (
                  <div class="mt-3 font-extrabold" style="color:#e5e5e5;">
                    {new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(p.price)}
                  </div>
                )}
              </div>
            </a>
          );
        })}
      </div>
    </section>

    <!-- BLOG (3) -->
    <section>
      <div class="flex items-end justify-between mb-5">
        <div>
          <p class="text-xs font-semibold uppercase tracking-widest" style="color:#1e88e5;">Autoridad</p>
          <h2 class="text-xl font-bold" style="color:#e5e5e5;">Artículos clave</h2>
        </div>
        <a href="/blog/" class="text-sm" style="color: rgba(229,229,229,0.55);">Ver blog</a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        {arts.map((a) => (
          <a href={`/blog/${a.slug}/`} class="rounded-3xl p-6 block"
            style="background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);">
            <div class="font-semibold" style="color:#e5e5e5;">{a.title}</div>
            {(a.description ?? a.excerpt) && (
              <p class="mt-2 text-sm" style="color: rgba(229,229,229,0.55);">
                {a.description ?? a.excerpt}
              </p>
            )}
          </a>
        ))}
      </div>
    </section>

  </main>
</BaseLayout>