---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Contacto | ZetaGadget" description="Contacta con ZetaGadget">
  <main class="mx-auto max-w-2xl px-4 py-10">
    <h1 class="text-3xl font-semibold">Contacto</h1>
    <p class="mt-2 text-sm opacity-80">
      EnvÃ­anos tu consulta y te responderemos lo antes posible.
    </p>

    <form id="contactForm" class="mt-8 space-y-4">
      <div>
        <label class="block text-sm font-medium" for="name">Nombre</label>
        <input class="mt-1 w-full rounded-md border px-3 py-2" id="name" name="name" autocomplete="name" required />
        <p class="mt-1 text-sm text-red-600 hidden" data-error="name"></p>
      </div>

      <div>
        <label class="block text-sm font-medium" for="email">Email</label>
        <input class="mt-1 w-full rounded-md border px-3 py-2" id="email" name="email" type="email" autocomplete="email" required />
        <p class="mt-1 text-sm text-red-600 hidden" data-error="email"></p>
      </div>

      <div>
        <label class="block text-sm font-medium" for="subject">Asunto</label>
        <input class="mt-1 w-full rounded-md border px-3 py-2" id="subject" name="subject" required />
        <p class="mt-1 text-sm text-red-600 hidden" data-error="subject"></p>
      </div>

      <div>
        <label class="block text-sm font-medium" for="message">Mensaje</label>
        <textarea class="mt-1 w-full rounded-md border px-3 py-2" id="message" name="message" rows="6" required></textarea>
        <p class="mt-1 text-sm text-red-600 hidden" data-error="message"></p>
      </div>

      <label class="flex items-start gap-2 text-sm">
        <input id="consent" name="consent" type="checkbox" class="mt-1" required />
        <span>Acepto la polÃ­tica de privacidad.</span>
      </label>
      <p class="mt-1 text-sm text-red-600 hidden" data-error="consent"></p>

      <button id="submitBtn" type="submit" class="rounded-md bg-black px-4 py-2 text-white">
        Enviar
      </button>

      <p id="formMsg" class="text-sm mt-3 hidden"></p>
    </form>
  </main>

  <script>
    const form = document.getElementById("contactForm");
    const msgEl = document.getElementById("formMsg");
    const submitBtn = document.getElementById("submitBtn");

    const showError = (key, text) => {
      const el = document.querySelector(`[data-error="${key}"]`);
      if (!el) return;
      el.textContent = text;
      el.classList.toggle("hidden", !text);
    };

    const clearErrors = () => ["name","email","subject","message","consent"].forEach(k => showError(k, ""));

    const normalize = (s) => (s || "").trim().replace(/\s+/g, " ");

    const validators = {
      name: (v) => /^[A-Za-zÃ€-Ã¿0-9\s.'-]{2,60}$/.test(v) ? "" : "Nombre no vÃ¡lido (2-60).",
      email: (v) => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(v) ? "" : "Email no vÃ¡lido.",
      subject: (v) => /^.{3,80}$/.test(v) ? "" : "Asunto no vÃ¡lido (3-80).",
      message: (v) => /^.{10,2000}$/s.test(v) ? "" : "Mensaje no vÃ¡lido (10-2000).",
      consent: (v) => v ? "" : "Debes aceptar la polÃ­tica."
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearErrors();

      const name = normalize(form.name.value);
      const email = normalize(form.email.value);
      const subject = normalize(form.subject.value);
      const message = (form.message.value || "").trim();
      const consent = form.consent.checked;

      const errors = {
        name: validators.name(name),
        email: validators.email(email),
        subject: validators.subject(subject),
        message: validators.message(message),
        consent: validators.consent(consent)
      };

      let hasError = false;
      for (const [k,v] of Object.entries(errors)) {
        if (v) { showError(k, v); hasError = true; }
      }
      if (hasError) return;

      submitBtn.disabled = true;
      msgEl.classList.remove("hidden");
      msgEl.textContent = "Enviando...";

      try {
        const res = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, subject, message, consent })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          msgEl.textContent = data?.error || "Error al enviar. IntÃ©ntalo de nuevo.";
          submitBtn.disabled = false;
          return;
        }

        msgEl.textContent = "Â¡Mensaje enviado! Gracias ðŸ˜Š";
        form.reset();
      } catch {
        msgEl.textContent = "Error de red. IntÃ©ntalo mÃ¡s tarde.";
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</BaseLayout>