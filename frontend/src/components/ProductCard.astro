---
import { absoluteUrl } from "../lib/strapi.js";

interface Category {
  name: string;
  slug: string;
}

interface Product {
  id: string | number;
  name: string;
  slug: string;
  price: number;
  shortDescription?: string;
  imageUrl?: string;
  featured?: boolean;
  stock?: number;
  category?: Category;
}

interface Props {
  product: Product;
}

const { product } = Astro.props as Props;

const {
  id,
  name,
  slug,
  price,
  shortDescription,
  imageUrl,
  featured = false,
  stock = 0,
  category,
} = product;

const inStock = stock > 0;
const productUrl = `/productos/${slug}/`; // ✅ trailing slash
const imgSrc = imageUrl ? absoluteUrl(imageUrl) : null; // ✅ convierte relativa -> absoluta

const formattedPrice = new Intl.NumberFormat("es-ES", {
  style: "currency",
  currency: "EUR",
  minimumFractionDigits: 2,
}).format(Number(price ?? 0));
---

<article
  data-product-card
  data-name={name}
  data-cat={category?.slug ?? ""}
  data-price={String(price)}
  class="group relative flex flex-col rounded-2xl overflow-hidden transition-all duration-300 hover:-translate-y-1 focus-within:-translate-y-1"
  style="background: #151a22; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 0 0 rgba(0,0,0,0);"
>
  <!-- Hover ring + shadow -->
  <div
    class="pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-300"
    style="box-shadow: 0 18px 45px rgba(0,0,0,0.35); border: 1px solid rgba(58,160,255,0.22); border-radius: 1rem;"
  ></div>

  {featured && (
    <div class="absolute top-3 left-3 z-10">
      <span
        class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold tracking-wide"
        style="background: rgba(30,136,229,0.18); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.35);"
      >
        <span class="w-2 h-2 rounded-full" style="background:#3aa0ff;"></span>
        Destacado
      </span>
    </div>
  )}

  {!inStock && (
    <div class="absolute inset-0 z-[5] pointer-events-none">
      <div class="absolute inset-0" style="background: rgba(10,12,18,0.45);"></div>
      <div class="absolute top-3 right-3">
        <span
          class="inline-flex items-center gap-1.5 text-xs font-semibold px-2.5 py-1 rounded-full"
          style="background: rgba(239,68,68,0.12); color: #f87171; border: 1px solid rgba(239,68,68,0.22);"
        >
          <span class="w-1.5 h-1.5 rounded-full" style="background:#f87171;"></span>
          Agotado
        </span>
      </div>
    </div>
  )}

  <!-- Media -->
  <a href={productUrl} class="block relative" aria-label={`Ver producto: ${name}`}>
    <div class="w-full aspect-[4/3] overflow-hidden" style="background: rgba(255,255,255,0.03);">
      {imgSrc ? (
        <img
          src={imgSrc}
          alt={name}
          width="800"
          height="600"
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-[1.06]"
          loading="lazy"
          decoding="async"
        />
      ) : (
        <div class="w-full h-full flex items-center justify-center">
          <div class="text-sm opacity-60">Sin imagen</div>
        </div>
      )}
    </div>

    <!-- subtle bottom gradient for readability -->
    <div
      class="pointer-events-none absolute inset-x-0 bottom-0 h-16"
      style="background: linear-gradient(180deg, rgba(21,26,34,0), rgba(21,26,34,0.95));"
    ></div>
  </a>

  <div class="relative flex flex-col flex-1 p-5 gap-3">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        {category && (
          <a
            href={`/categorias/${category.slug}/`}
            class="text-xs font-semibold w-fit inline-flex items-center gap-2"
            style="color: rgba(30,136,229,0.92);"
          >
            <span class="inline-block w-1.5 h-1.5 rounded-full" style="background: rgba(58,160,255,0.9);"></span>
            {category.name}
          </a>
        )}

        <a href={productUrl} class="group/title block mt-1">
          <h2 class="text-base font-semibold leading-snug truncate" style="color: #e5e5e5;">
            {name}
          </h2>
        </a>
      </div>

      <span
        class="shrink-0 inline-flex items-center gap-1.5 text-xs font-medium px-2.5 py-1 rounded-full"
        style={inStock
          ? "background: rgba(34,197,94,0.10); color: #4ade80; border: 1px solid rgba(34,197,94,0.20);"
          : "background: rgba(239,68,68,0.10); color: #f87171; border: 1px solid rgba(239,68,68,0.18);"}
        aria-label={inStock ? "Producto en stock" : "Producto sin stock"}
      >
        <span class="w-1.5 h-1.5 rounded-full" style={inStock ? "background:#4ade80;" : "background:#f87171;"}></span>
        {inStock ? "En stock" : "Sin stock"}
      </span>
    </div>

    {shortDescription && (
      <p class="text-sm leading-relaxed line-clamp-2" style="color: rgba(229,229,229,0.55);">
        {shortDescription}
      </p>
    )}

    <div class="flex items-end justify-between mt-auto pt-2">
      <div class="flex flex-col">
        <span class="text-xs" style="color: rgba(229,229,229,0.45);">Precio</span>
        <span class="text-xl font-extrabold tracking-tight" style="color: #e5e5e5;">
          {formattedPrice}
        </span>
      </div>
    </div>

    <div class="mt-2 grid grid-cols-2 gap-2">
      <a
        href={productUrl}
        class="w-full text-center py-2.5 px-4 rounded-xl text-sm font-semibold transition-all duration-200 focus:outline-none focus-visible:ring-2"
        style="background: rgba(30,136,229,0.10); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.22);"
      >
        Ver
      </a>

      <button
        type="button"
        class="w-full text-center py-2.5 px-4 rounded-xl text-sm font-semibold transition-all duration-200 focus:outline-none focus-visible:ring-2"
        style={inStock
          ? "background:#1e88e5;color:#fff;border:1px solid #1e88e5;"
          : "background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.45); border:1px solid rgba(255,255,255,0.10); cursor:not-allowed;"}
        disabled={!inStock}
        data-add-to-cart
        data-id={String(id)}
        data-name={name}
        data-price={String(price)}
        data-slug={slug}
      >
        Añadir
      </button>
    </div>
  </div>
</article>

<script type="module">
  import { addToCart } from "../lib/cart.js";

  if (!window.__ZG_CART_LISTENER__) {
    window.__ZG_CART_LISTENER__ = true;

    document.addEventListener("click", (ev) => {
      const btn = ev.target?.closest?.("[data-add-to-cart]");
      if (!btn) return;

      addToCart({
        id: btn.dataset.id,
        name: btn.dataset.name,
        price: Number(btn.dataset.price || 0),
        slug: btn.dataset.slug,
        qty: 1,
      });

      if (typeof window.openCart === "function") window.openCart();
    });
  }
</script>