---
// src/components/ProductCard.astro
interface Category {
  name: string;
  slug: string;
}

interface Product {
  id: string | number;
  name: string;
  slug: string;
  price: number;
  shortDescription?: string;
  imageUrl?: string;
  featured?: boolean;
  stock?: number;
  category?: Category;
}

interface Props {
  product: Product;
}

const { product } = Astro.props;

const {
  id,
  name,
  slug,
  price,
  shortDescription,
  imageUrl,
  featured = false,
  stock = 0,
  category,
} = product;

const inStock = stock > 0;
const productUrl = `/productos/${slug}`;

const formattedPrice = new Intl.NumberFormat("es-ES", {
  style: "currency",
  currency: "EUR",
  minimumFractionDigits: 2,
}).format(price);
---

<article
  class="group relative flex flex-col rounded-xl overflow-hidden transition-all duration-300"
  style="background: #151a22; border: 1px solid rgba(255,255,255,0.08);"
>
  {featured && (
    <div class="absolute top-3 left-3 z-10">
      <span
        class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold tracking-wide"
        style="background: rgba(30,136,229,0.18); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.35);"
      >
        <span class="w-2 h-2 rounded-full" style="background:#3aa0ff;"></span>
        Destacado
      </span>
    </div>
  )}

  <a href={productUrl} class="block overflow-hidden" tabindex="-1" aria-hidden="true">
    {imageUrl ? (
      <img
        src={imageUrl}
        alt={name}
        class="w-full h-48 object-cover transition-transform duration-500 group-hover:scale-105"
        loading="lazy"
        decoding="async"
      />
    ) : (
      <div class="w-full h-48 flex items-center justify-center" style="background: rgba(255,255,255,0.03);">
        <div class="text-sm opacity-60">Sin imagen</div>
      </div>
    )}
  </a>

  <div class="flex flex-col flex-1 p-5 gap-3">
    {category && (
      <a href={`/categorias/${category.slug}`} class="text-xs font-medium w-fit" style="color: rgba(30,136,229,0.9);">
        {category.name}
      </a>
    )}

    <a href={productUrl} class="group/title">
      <h2 class="text-base font-semibold leading-snug" style="color: #e5e5e5;">
        {name}
      </h2>
    </a>

    {shortDescription && (
      <p class="text-sm leading-relaxed line-clamp-2 flex-1" style="color: rgba(229,229,229,0.55);">
        {shortDescription}
      </p>
    )}

    <div class="flex items-center justify-between mt-auto pt-2">
      <span class="text-lg font-bold" style="color: #e5e5e5;">
        {formattedPrice}
      </span>

      <span
        class="inline-flex items-center gap-1.5 text-xs font-medium px-2.5 py-1 rounded-full"
        style={inStock
          ? "background: rgba(34,197,94,0.1); color: #4ade80; border: 1px solid rgba(34,197,94,0.2);"
          : "background: rgba(239,68,68,0.1); color: #f87171; border: 1px solid rgba(239,68,68,0.2);"}
      >
        <span class="w-1.5 h-1.5 rounded-full" style={inStock ? "background: #4ade80;" : "background: #f87171;"}></span>
        {inStock ? "En stock" : "Sin stock"}
      </span>
    </div>

    <div class="mt-2 grid grid-cols-2 gap-2">
      <a
        href={productUrl}
        class="w-full text-center py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-200"
        style="background: rgba(30,136,229,0.12); color: #3aa0ff; border: 1px solid rgba(30,136,229,0.25);"
      >
        Ver
      </a>

      <button
        type="button"
        class="w-full text-center py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-200"
        style={inStock
          ? "background:#1e88e5;color:#fff;border:1px solid #1e88e5;"
          : "background: rgba(255,255,255,0.06); color: rgba(229,229,229,0.45); border:1px solid rgba(255,255,255,0.10); cursor:not-allowed;"}
        disabled={!inStock}
        data-add-to-cart
        data-id={String(id)}
        data-name={name}
        data-price={String(price)}
      >
        AÃ±adir
      </button>
    </div>
  </div>
</article>

<script type="module">
  import { addToCart } from "../lib/cart.js";

  document.querySelectorAll("[data-add-to-cart]").forEach((btn) => {
    btn.addEventListener("click", () => {
      addToCart({
        id: btn.dataset.id,
        name: btn.dataset.name,
        price: Number(btn.dataset.price || 0),
      });
    });
  });
</script>