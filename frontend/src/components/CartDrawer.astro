---
// src/components/CartDrawer.astro
---

<!-- Backdrop -->
<div
  id="cartBackdrop"
  class="fixed inset-0 z-[90] hidden"
  style="background: rgba(0,0,0,0.55);"
  aria-hidden="true"
></div>

<!-- Drawer -->
<aside
  id="cartDrawer"
  class="fixed top-0 right-0 h-full w-[92vw] max-w-md z-[100] translate-x-full transition-transform duration-300"
  style="background:#0f1115; border-left: 1px solid rgba(255,255,255,0.08);"
  aria-label="Carrito"
>
  <!-- Header -->
  <div
    class="p-5 flex items-center justify-between"
    style="border-bottom: 1px solid rgba(255,255,255,0.08);"
  >
    <div class="flex items-center gap-2">
      <div
        class="w-9 h-9 rounded-xl flex items-center justify-center"
        style="background: rgba(30,136,229,0.12); border: 1px solid rgba(30,136,229,0.22);"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6h15l-1.5 9h-12L6 6Z" stroke="rgba(58,160,255,0.9)" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M6 6 5 3H2" stroke="rgba(58,160,255,0.9)" stroke-width="1.6" stroke-linecap="round"/>
          <circle cx="9" cy="20" r="1" fill="rgba(58,160,255,0.9)"/>
          <circle cx="18" cy="20" r="1" fill="rgba(58,160,255,0.9)"/>
        </svg>
      </div>
      <div>
        <p class="text-sm font-semibold" style="color:#e5e5e5;">Carrito</p>
        <p id="cartCountLabel" class="text-xs" style="color: rgba(229,229,229,0.45);">0 artículos</p>
      </div>
    </div>

    <button
      id="cartCloseBtn"
      type="button"
      class="rounded-xl px-3 py-2 text-sm font-semibold"
      style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); color: rgba(229,229,229,0.85);"
      aria-label="Cerrar carrito"
    >
      Cerrar
    </button>
  </div>

  <!-- Content -->
  <div class="p-5 overflow-auto" style="height: calc(100vh - 168px);">
    <div id="cartRoot"></div>
  </div>

  <!-- Footer -->
  <div
    class="p-5"
    style="border-top: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02);"
  >
    <div class="flex items-center justify-between mb-3">
      <span class="text-sm font-semibold" style="color: rgba(229,229,229,0.75);">Total</span>
      <span id="cartTotal" class="text-lg font-extrabold" style="color:#e5e5e5;">0,00 €</span>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <button
        id="cartClearBtn"
        type="button"
        class="rounded-xl px-4 py-3 text-sm font-semibold"
        style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); color: rgba(229,229,229,0.85);"
      >
        Vaciar
      </button>

      <a
        href="/contacto"
        class="rounded-xl px-4 py-3 text-sm font-semibold text-center"
        style="background:#1e88e5; border:1px solid #1e88e5; color:#fff; box-shadow: 0 10px 30px rgba(30,136,229,0.18);"
      >
        Finalizar (demo)
      </a>
    </div>

    <p class="mt-3 text-xs" style="color: rgba(229,229,229,0.40);">
      *Demo: no hay pago real, solo flujo de proyecto.
    </p>
  </div>
</aside>

<script type="module">
  const drawer = document.querySelector("[data-cart-drawer]");
  const overlay = document.querySelector("[data-cart-overlay]");
  const closeBtn = document.querySelector("[data-cart-close]");
  const itemsEl = document.querySelector("[data-cart-items]");
  const emptyEl = document.querySelector("[data-cart-empty]");
  const countEls = document.querySelectorAll("[data-cart-count]");
  const totalEl = document.querySelector("[data-cart-total]");

  const money = (n) =>
    new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(Number(n || 0));

  function open() {
    drawer?.classList.remove("translate-x-full");
    overlay?.classList.remove("hidden");
  }

  function close() {
    drawer?.classList.add("translate-x-full");
    overlay?.classList.add("hidden");
  }

  function render(cart) {
    const totalCount = cart.reduce((acc, it) => acc + (it.qty || 0), 0);
    const totalPrice = cart.reduce((acc, it) => acc + (it.qty || 0) * (it.price || 0), 0);

    countEls.forEach((el) => (el.textContent = String(totalCount)));
    if (totalEl) totalEl.textContent = money(totalPrice);

    if (!itemsEl || !emptyEl) return;

    if (cart.length === 0) {
      itemsEl.innerHTML = "";
      emptyEl.classList.remove("hidden");
      return;
    }

    emptyEl.classList.add("hidden");

    itemsEl.innerHTML = cart
      .map(
        (it) => `
        <div class="flex items-center justify-between gap-3 p-3 rounded-xl"
          style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);">
          <div class="min-w-0">
            <div class="text-sm font-semibold" style="color:#e5e5e5; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${it.name}
            </div>
            <div class="text-xs" style="color: rgba(229,229,229,0.55);">
              ${it.qty} × ${money(it.price)}
            </div>
          </div>
          <div class="text-sm font-bold" style="color:#e5e5e5;">
            ${money((it.qty || 0) * (it.price || 0))}
          </div>
        </div>
      `
      )
      .join("");
  }

  // Eventos globales
  window.addEventListener("cart:open", open);
  window.addEventListener("cart:close", close);

  // Cerrar
  closeBtn?.addEventListener("click", close);
  overlay?.addEventListener("click", close);

  // Re-render cuando cambie
  window.addEventListener("cart:updated", (e) => render(e.detail?.cart ?? []));

  // Render inicial
  const api = window.ZG_CART;
  render(api?.getCart ? api.getCart() : []);
</script>