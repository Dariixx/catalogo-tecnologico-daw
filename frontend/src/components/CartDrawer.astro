---
import { readCart, addToCart, incQty, removeFromCart } from "../lib/cart.js";
---

<!-- Overlay -->
<div id="zgCartOverlay" class="fixed inset-0 z-[90] hidden" style="background: rgba(0,0,0,.55);"></div>

<!-- Drawer -->
<aside
  id="zgCartDrawer"
  class="fixed top-0 right-0 h-full w-[360px] max-w-[90vw] z-[100] translate-x-full transition-transform duration-300 flex flex-col"
  style="background:#151a22; border-left:1px solid rgba(255,255,255,0.10);"
  aria-label="Carrito"
>
  <div class="h-16 px-5 flex items-center justify-between" style="border-bottom:1px solid rgba(255,255,255,0.08);">
    <div class="font-semibold" style="color:#e5e5e5;">Carrito</div>
    <button id="zgCartClose" class="w-9 h-9 rounded-lg" style="border:1px solid rgba(255,255,255,0.10); color:#e5e5e5;">
      ✕
    </button>
  </div>

  <div id="zgCartBody" class="p-5 space-y-3" style="color: rgba(229,229,229,0.8);"></div>

  <div class="mt-auto p-5" style="border-top:1px solid rgba(255,255,255,0.08);">
    <div class="flex items-center justify-between mb-3">
      <span style="color: rgba(229,229,229,0.6);">Total</span>
      <strong id="zgCartTotal" style="color:#e5e5e5;">0,00 €</strong>
    </div>
    <button
      type="button"
      class="w-full py-2.5 rounded-xl font-semibold"
      style="background:#1e88e5;color:#fff;border:1px solid #1e88e5;"
    >
      Finalizar (demo)
    </button>
  </div>
</aside>

<script type="module">
  

  const drawer = document.getElementById("zgCartDrawer");
  const overlay = document.getElementById("zgCartOverlay");
  const closeBtn = document.getElementById("zgCartClose");
  const body = document.getElementById("zgCartBody");
  const totalEl = document.getElementById("zgCartTotal");
  const badge = document.getElementById("cartBadge");

  const euro = new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" });

  function render() {
    const items = readCart();

    // badge
    if (badge) {
      const n = items.reduce((a, it) => a + (Number(it.qty) || 1), 0);
      badge.textContent = String(n);
      badge.classList.toggle("hidden", n <= 0);
    }

    if (!body || !totalEl) return;

    if (!items.length) {
      body.innerHTML = '<div style="opacity:.65">Tu carrito está vacío.</div>';
      totalEl.textContent = euro.format(0);
      return;
    }

    let total = 0;

    body.innerHTML = items.map((it) => {
      const id = String(it.id ?? it.slug ?? "");
      const price = Number(it.price) || 0;
      const q = Math.max(1, Number(it.qty) || 1);
      total += price * q;

      return `
        <div style="border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); border-radius: 14px; padding: 12px;">
          <div style="display:flex; justify-content:space-between; gap:12px;">
            <div style="min-width:0;">
              <div style="font-weight:600; color:#e5e5e5; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                ${it.name || "Producto"}
              </div>
              <div style="opacity:.6; font-size: 12px; margin-top:2px;">
                ${euro.format(price)}
              </div>
            </div>

            <button
              type="button"
              data-remove-id="${id}"
              style="opacity:.8; border:1px solid rgba(255,255,255,0.10); background:transparent; color:#e5e5e5; border-radius:10px; padding:6px 10px;"
            >
              Quitar
            </button>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
              <button
                type="button"
                data-dec-id="${id}"
                style="width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:transparent;color:#e5e5e5;"
              >−</button>

              <strong style="min-width:22px; text-align:center;">${q}</strong>

              <button
                type="button"
                data-inc-id="${id}"
                style="width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:transparent;color:#e5e5e5;"
              >+</button>
            </div>

            <strong style="color:#e5e5e5;">${euro.format(price * q)}</strong>
          </div>
        </div>
      `;
    }).join("");

    totalEl.textContent = euro.format(total);
  }

  function openCart() {
    overlay?.classList.remove("hidden");
    drawer?.classList.remove("translate-x-full");
    render();
  }

  function closeCart() {
    drawer?.classList.add("translate-x-full");
    overlay?.classList.add("hidden");
  }

  window.openCart = openCart;
  window.closeCart = closeCart;

  // Listener único: abrir + acciones + añadir global
  document.addEventListener("click", (e) => {
    const t = e.target instanceof Element ? e.target : null;
    if (!t) return;

    // Abrir
    if (t.closest("[data-open-cart], [data-cart-button]")) {
      e.preventDefault();
      openCart();
      return;
    }

    // Añadir (cualquier botón del sitio)
    const addBtn = t.closest("[data-add-to-cart]");
    if (addBtn) {
      e.preventDefault();

      addToCart({
        id: addBtn.getAttribute("data-id") || addBtn.getAttribute("data-slug") || "",
        name: addBtn.getAttribute("data-name") || "Producto",
        price: Number(addBtn.getAttribute("data-price") || 0),
        slug: addBtn.getAttribute("data-slug") || "",
        qty: 1,
      });

      openCart();
      return;
    }

    // Quitar / + / -
    const rm = t.closest("[data-remove-id]");
    if (rm) {
      removeFromCart(rm.getAttribute("data-remove-id"));
      render();
      return;
    }

    const inc = t.closest("[data-inc-id]");
    if (inc) {
      incQty(inc.getAttribute("data-inc-id"), 1);
      render();
      return;
    }

    const dec = t.closest("[data-dec-id]");
    if (dec) {
      incQty(dec.getAttribute("data-dec-id"), -1);
      render();
      return;
    }
  });

  overlay?.addEventListener("click", closeCart);
  closeBtn?.addEventListener("click", closeCart);

  window.addEventListener("cart:updated", render);
  window.addEventListener("storage", render);

  render();
</script>