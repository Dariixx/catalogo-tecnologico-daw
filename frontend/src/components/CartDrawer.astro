---
// src/components/CartDrawer.astro
---

<!-- Backdrop -->
<div
  id="cartBackdrop"
  class="fixed inset-0 z-[90] hidden"
  style="background: rgba(0,0,0,0.55);"
  aria-hidden="true"
></div>

<!-- Drawer -->
<aside
  id="cartDrawer"
  class="fixed top-0 right-0 h-full w-[92vw] max-w-md z-[100] translate-x-full transition-transform duration-300"
  style="background:#0f1115; border-left: 1px solid rgba(255,255,255,0.08);"
  aria-label="Carrito"
>
  <!-- Header -->
  <div
    class="p-5 flex items-center justify-between"
    style="border-bottom: 1px solid rgba(255,255,255,0.08);"
  >
    <div class="flex items-center gap-2">
      <div
        class="w-9 h-9 rounded-xl flex items-center justify-center"
        style="background: rgba(30,136,229,0.12); border: 1px solid rgba(30,136,229,0.22);"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6h15l-1.5 9h-12L6 6Z" stroke="rgba(58,160,255,0.9)" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M6 6 5 3H2" stroke="rgba(58,160,255,0.9)" stroke-width="1.6" stroke-linecap="round"/>
          <circle cx="9" cy="20" r="1" fill="rgba(58,160,255,0.9)"/>
          <circle cx="18" cy="20" r="1" fill="rgba(58,160,255,0.9)"/>
        </svg>
      </div>
      <div>
        <p class="text-sm font-semibold" style="color:#e5e5e5;">Carrito</p>
        <p id="cartCountLabel" class="text-xs" style="color: rgba(229,229,229,0.45);">0 artículos</p>
      </div>
    </div>

    <button
      id="cartCloseBtn"
      type="button"
      class="rounded-xl px-3 py-2 text-sm font-semibold"
      style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); color: rgba(229,229,229,0.85);"
      aria-label="Cerrar carrito"
    >
      Cerrar
    </button>
  </div>

  <!-- Content -->
  <div class="p-5 overflow-auto" style="height: calc(100vh - 168px);">
    <div id="cartRoot"></div>
  </div>

  <!-- Footer -->
  <div
    class="p-5"
    style="border-top: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02);"
  >
    <div class="flex items-center justify-between mb-3">
      <span class="text-sm font-semibold" style="color: rgba(229,229,229,0.75);">Total</span>
      <span id="cartTotal" class="text-lg font-extrabold" style="color:#e5e5e5;">0,00 €</span>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <button
        id="cartClearBtn"
        type="button"
        class="rounded-xl px-4 py-3 text-sm font-semibold"
        style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); color: rgba(229,229,229,0.85);"
      >
        Vaciar
      </button>

      <a
        href="/contacto"
        class="rounded-xl px-4 py-3 text-sm font-semibold text-center"
        style="background:#1e88e5; border:1px solid #1e88e5; color:#fff; box-shadow: 0 10px 30px rgba(30,136,229,0.18);"
      >
        Finalizar (demo)
      </a>
    </div>

    <p class="mt-3 text-xs" style="color: rgba(229,229,229,0.40);">
      *Demo: no hay pago real, solo flujo de proyecto.
    </p>
  </div>
</aside>

<script type="module">
  import { getCart, removeFromCart, setQty, clearCart } from "../lib/cart.js";

  const drawer   = document.getElementById("cartDrawer");
  const backdrop = document.getElementById("cartBackdrop");
  const closeBtn = document.getElementById("cartCloseBtn");

  const root     = document.getElementById("cartRoot");
  const totalEl  = document.getElementById("cartTotal");
  const countEl  = document.getElementById("cartCountLabel");
  const clearBtn = document.getElementById("cartClearBtn");

  const money = (n) =>
    new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(Number(n || 0));

  function openCart() {
    drawer.classList.remove("translate-x-full");
    backdrop.classList.remove("hidden");
    document.documentElement.style.overflow = "hidden";
  }

  function closeCart() {
    drawer.classList.add("translate-x-full");
    backdrop.classList.add("hidden");
    document.documentElement.style.overflow = "";
  }

  function render() {
    const items = getCart();
    const count = items.reduce((acc, it) => acc + (Number(it.qty) || 1), 0);
    const total = items.reduce((acc, it) => acc + (Number(it.price) * (Number(it.qty) || 1)), 0);

    // Badge del header si existe
    const badge = document.getElementById("cartBadge");
    if (badge) {
      badge.textContent = String(count);
      badge.classList.toggle("hidden", count <= 0);
    }

    countEl.textContent = `${count} artículo${count !== 1 ? "s" : ""}`;
    totalEl.textContent = money(total);

    if (!items.length) {
      root.innerHTML = `
        <div class="rounded-2xl p-5"
             style="background:#151a22;border:1px solid rgba(255,255,255,0.08);">
          <p style="color: rgba(229,229,229,0.75); font-weight: 700;">Tu carrito está vacío</p>
          <p class="mt-1 text-sm" style="color: rgba(229,229,229,0.45);">
            Añade productos y aparecerán aquí.
          </p>
          <a href="/productos"
             class="inline-flex mt-4 px-4 py-2 rounded-xl text-sm font-semibold"
             style="background:#1e88e5;color:#fff;border:1px solid #1e88e5;">
            Ver productos
          </a>
        </div>
      `;
      return;
    }

    root.innerHTML = `
      <div class="grid gap-3">
        ${items.map(it => `
          <div class="rounded-2xl p-4"
               style="background:#151a22;border:1px solid rgba(255,255,255,0.08);">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold truncate" style="color:#e5e5e5;">${it.name}</div>
                <div class="text-sm" style="color: rgba(229,229,229,0.55);">${money(it.price)}</div>
              </div>

              <button data-remove="${it.id}"
                      class="px-3 py-1 rounded-xl text-xs font-semibold"
                      style="background: rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.25);">
                Quitar
              </button>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <div class="text-xs" style="color: rgba(229,229,229,0.45);">Cantidad</div>
              <input data-qty="${it.id}" type="number" min="1" value="${it.qty || 1}"
                     class="w-24 rounded-xl px-3 py-2 text-sm outline-none"
                     style="background:#0f1115;border:1px solid rgba(255,255,255,0.12);color:#e5e5e5;" />
            </div>
          </div>
        `).join("")}
      </div>
    `;

    root.querySelectorAll("[data-remove]").forEach((btn) => {
      btn.addEventListener("click", () => {
        removeFromCart(btn.dataset.remove);
        render();
      });
    });

    root.querySelectorAll("[data-qty]").forEach((inp) => {
      inp.addEventListener("change", () => {
        const id = inp.dataset.qty;
        const qty = Math.max(1, Number(inp.value || 1));
        setQty(id, qty);
        render();
      });
    });
  }

  closeBtn.addEventListener("click", closeCart);
  backdrop.addEventListener("click", closeCart);
  clearBtn.addEventListener("click", () => {
    clearCart();
    render();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeCart();
  });

  // API global
  window.openCart = () => {
    render();
    openCart();
  };

  // Re-render cuando cambia el carrito
  window.addEventListener("cart:updated", render);

  // Render inicial (para badge / total)
  render();
</script>